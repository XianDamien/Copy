# Context
Filename: task-50-review-interface-critical-fixes.md
Created On: 2025-01-27
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
Fix three critical bugs in the Review interface:
1. 侧边栏中参考翻译是空白的，没有显示任何内容，学习笔记也是空白的，有一些卡片明明有笔记，但是没显示出来
2. 点击Ctrl+S显示出来的是一个保存网页文件的弹窗，非常逆天
3. 新的笔记会把原有的笔记覆盖掉，但是我想的逻辑应该是侧边栏目随时都可以呈现出原有的笔记，并且相应地增添修改，而且任务时间戳反而不算是一个非常重要的功能，只要能记下日期就可以

# Project Overview
LanGear is a language learning application built with TypeScript + React + Vite. The Review interface is a core component that allows users to study cards, translate content, and take notes. The current implementation has critical data flow and user experience issues that need immediate resolution.

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
## Code Investigation Results
- **Key Files:** `src/main/pages/Review.tsx`, `src/main/components/review/SidePanel.tsx`
- **Root Causes Identified:**
  1. **Blank Side Panel:** The `SidePanel` component receives props directly from `getCurrentCard()` instead of the intermediate state (`pendingReferenceTranslation`, `pendingStudyNotes`) that holds user edits
  2. **Ctrl+S Failure:** The keyboard shortcut `useEffect` has a stale closure problem - the `handleSaveChanges` function doesn't have access to the latest state
  3. **Note Overwriting:** Two functions (`handleSaveChanges` and `saveTranslationToNotes`) modify the notes field independently, causing overwrites
  4. **Timestamp Format:** Current timestamp is too detailed, needs to be simplified to YYYY-MM-DD format

## Dependencies and Constraints
- Must maintain existing functionality while fixing bugs
- Need to preserve data integrity during note updates
- Should not break existing keyboard shortcuts for other functions
- Must ensure proper state management for real-time editing

# Proposed Solution (Populated by INNOVATE mode)
## Approach Selected
Three-phase sequential implementation:
- **Phase 1:** Fix data flow to SidePanel and resolve Ctrl+S stale closure
- **Phase 2:** Unify note saving logic and update timestamp format
- **Phase 3:** Add confirmation toasts and final integration

## Pros/Cons Evaluation
**Pros:**
- Sequential approach allows for testing at each stage
- Unified note saving logic prevents future conflicts
- Maintains backward compatibility
- Improves user experience with proper feedback

**Cons:**
- Requires careful state management to avoid introducing new bugs
- Need to ensure all edge cases are covered in the unified logic

# Implementation Plan (Generated by PLAN mode)
## Phase 1: Fix Side Panel Data Flow and Ctrl+S Shortcut
1. **File: `src/main/pages/Review.tsx`**
   - Update `renderReviewInterface` and `renderTaskInterface` functions
   - Change `SidePanel` props to use `pendingReferenceTranslation` and `pendingStudyNotes`
   - Fix keyboard shortcut `useEffect` dependency array to prevent stale closures

## Phase 2: Unify Note Saving Logic and Update Timestamp
1. **File: `src/main/pages/Review.tsx`**
   - Modify `saveTranslationToNotes` to use YYYY-MM-DD timestamp format
   - Refactor `handleSaveChanges` to use unified update logic
   - Create new `updateNoteContent` function for consistent note updates
   - Update `handleNoteFieldUpdate` to properly manage pending states

## Phase 3: Add Confirmation Toasts and Finalize
1. **File: `src/main/pages/Review.tsx`**
   - Add success/error toasts to `handleSaveChanges`
   - Verify all three issues are resolved
   - Test complete user workflow

## Testing Strategy
- Create focused tests for each phase
- Test data flow, keyboard shortcuts, and note persistence
- Verify edge cases and error handling
- Clean up test files after validation 