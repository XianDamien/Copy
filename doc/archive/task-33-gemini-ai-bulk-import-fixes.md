# Task 33: Gemini AI批量导入功能修复

## Context
**Filename**: task-33-gemini-ai-bulk-import-fixes.md  
**Created On**: 2024-12-19  
**Created By**: AI Assistant  
**Associated Protocol**: RIPER-5 + Multidimensional + Agent Protocol

## Task Description
修复AI驱动的批量制卡功能中的三个核心问题：
1. **AI自动分句功能缺失** - 重新实现geminiService以支持智能文本处理
2. **批量导入功能失效** - 修复数据流中的deckId处理问题
3. **Gemini API密钥验证** - 实现在线API密钥验证功能

## Project Overview
AnGear是一个基于Chrome扩展的语言学习工具，使用FSRS算法和任务驱动学习模式。批量导入功能允许用户快速创建大量学习卡片，AI功能可以自动识别和配对中英文句子。

---

## Analysis (Populated by RESEARCH mode)

### 问题1: AI自动分句功能
- **根本原因**: `src/background/geminiService.ts` 被删除
- **现状**: `AI_PROCESS_TEXT` 处理器存在但只返回"功能暂未实现"
- **影响**: 用户无法使用AI自动处理双语文本

### 问题2: 批量导入失效
- **数据流问题**:
  - `BulkImportPage.tsx:133-143` - notesData构建时缺少deckId字段
  - `background/index.ts:257-270` - BULK_CREATE_NOTES处理器未正确处理deckId
  - `db.ts:340-348` - bulkCreateNotes期望notes包含deckId但前端未提供

### 问题3: API密钥验证
- **现有基础**: UI界面完整，settingsService有基本验证
- **缺失功能**: 在线API调用验证密钥有效性

### 技术依赖分析
- **已有**: UserSettings接口、API客户端框架、消息处理基础设施
- **需要**: geminiService实现、数据流修复、验证API集成

---

## Proposed Solution (Populated by INNOVATE mode)

### 方案1: 重新实现geminiService
- **优势**: 完整的AI功能，智能文本处理
- **实现**: 创建GeminiService类，集成Google Generative AI API
- **Prompt设计**: 专门用于双语文本识别和句子配对

### 方案2: 修复数据流
- **前端修复**: 在notesData中添加deckId字段
- **后端修复**: BULK_CREATE_NOTES正确解构和传递deckId
- **数据库兼容**: 确保bulkCreateNotes正确处理包含deckId的notes

### 方案3: API密钥验证
- **验证端点**: 使用Gemini API的models列表端点进行轻量级验证
- **用户体验**: 添加验证按钮，显示验证状态和错误信息
- **安全性**: 密钥本地存储，仅在验证时发送

---

## Implementation Plan (Generated by PLAN mode)

### Phase 1: 重新实现geminiService
1. **创建geminiService.ts**
   - 文件路径: `src/background/geminiService.ts`
   - 实现GeminiService类
   - processTextForCards方法用于智能文本处理
   - 错误处理：API密钥验证、配额限制、网络错误

2. **更新AI_PROCESS_TEXT处理器**
   - 文件: `src/background/index.ts`
   - 集成geminiService调用
   - 添加错误处理和日志记录

3. **测试AI功能**
   - 创建: `src/tests/gemini-service.test.ts`
   - 测试文本处理、错误处理、API集成

### Phase 2: 修复批量导入数据流
4. **修复前端数据构建**
   - 文件: `src/main/pages/BulkImportPage.tsx`
   - 在notesData中添加deckId字段
   - 确保每个note对象包含正确的deckId

5. **修复后端处理器**
   - 文件: `src/background/index.ts`
   - BULK_CREATE_NOTES正确解构{deckId, notes}
   - 传递完整的notes数据到数据库

6. **测试批量导入**
   - 更新: `src/tests/bulk-import-fix.test.tsx`
   - 测试完整的导入流程
   - 验证卡片正确创建到指定牌组

### Phase 3: 实现API密钥验证
7. **添加验证API方法**
   - 文件: `src/shared/utils/api.ts`
   - 添加verifyGeminiApiKey方法

8. **创建后端验证处理器**
   - 文件: `src/background/index.ts`
   - 添加VERIFY_GEMINI_API_KEY消息处理
   - 调用Gemini API验证密钥

9. **更新设置页面UI**
   - 文件: `src/main/pages/SettingsPage.tsx`
   - 添加验证按钮和状态显示
   - 实现验证逻辑和用户反馈

### Phase 4: 集成AI到批量导入页面
10. **添加AI处理按钮**
    - 文件: `src/main/pages/BulkImportPage.tsx`
    - 添加"AI处理"按钮
    - 实现handleAiProcess函数

11. **集成AI处理流程**
    - 调用aiProcessText API
    - 处理AI响应并更新文本区域
    - 添加加载状态和错误处理

### Phase 5: 综合测试和文档
12. **端到端测试**
    - 测试完整的AI处理+批量导入流程
    - 验证所有错误场景处理
    - 性能测试和用户体验验证

13. **创建实施总结文档**
    - 文档路径: `doc/issues/task-33-implementation-summary.md`
    - 记录所有修复、测试结果、经验教训

## 具体测试命令

### geminiService测试
```bash
npm test src/tests/gemini-service.test.ts
```

### 批量导入测试
```bash
npm test src/tests/bulk-import-fix.test.tsx
```

### 集成测试
```bash
npm test -- --testPathPattern="bulk-import|gemini"
```

## 验收标准
- [ ] AI可以正确识别和配对中英文句子
- [ ] 批量导入功能可以成功创建卡片到指定牌组
- [ ] API密钥验证功能正常工作
- [ ] 所有相关测试通过
- [ ] 用户界面响应流畅，错误处理完善 