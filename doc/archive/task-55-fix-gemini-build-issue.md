# Context
Filename: task-55-fix-gemini-build-issue.md
Created On: 2024-12-19
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
修复在执行了代码重构后，扩展程序仍然抛出 `ReferenceError: window is not defined` 的问题。根本原因是构建缓存（stale build cache）导致旧的、有问题的代码被打包和执行。

# Project Overview
LanGear是一款基于Chrome扩展的语言学习工具，采用双相学习系统（任务阶段+复习阶段）。修复`geminiService.ts`的尝试因构建过程问题而未生效，导致AI功能持续失败。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## 问题诊断
- **根本原因**: Vite的构建缓存问题。即使 `src/background/geminiService.ts` 的源代码已被正确修改为使用 `fetch` API，但构建系统复用了 `dist` 目录中由旧代码（依赖SDK和`window`对象）生成的JS模块
- **触发流程**: `src/background/index.ts` 通过动态导入 (`import()`) 加载 `geminiService`。Vite将这个动态导入的模块分割成一个独立的文件 (`geminiService-B9yebQZR.js`)。在没有清理缓存的情况下进行构建时，这个被分割出来的文件没有被更新
- **用户确认**: 用户已确认在两次尝试之间没有清除构建缓存 (`dist` 目录和 `node_modules`)，也没有对Vite配置做过修改

## 技术分析
- **动态导入复杂性**: 代码分割（code splitting）导致 `geminiService` 被打包成独立模块
- **缓存机制**: Vite的增量构建机制在检测到已存在的构建产物时，可能跳过重新编译某些模块
- **Chrome扩展特性**: Service Worker的缓存机制可能进一步复合了问题

## 验证方法
通过检查 `dist/assets/src/background/index-DQ1tH8F0.js` 文件中的代码，发现其中包含了对 `geminiService-B9yebQZR.js` 的动态导入，这确认了问题的根源

# Proposed Solution (Populated by INNOVATE mode)

## 推荐方案: 完全清理构建环境
**核心策略**: 这是一个纯粹的流程修复，旨在确保一个完全干净的构建和部署环境。它不涉及代码修改，而是通过彻底清理构建缓存来解决问题。

### 优势分析
1. **根本性解决**: 从源头解决构建缓存问题，确保所有代码都从最新源文件重新编译
2. **无风险**: 不涉及代码修改，只是清理和重建，不会引入新的bug
3. **可重复**: 建立了一个标准的清理和重建流程，可用于未来类似问题
4. **验证简单**: 问题修复后，错误将立即消失，验证结果明确

### 实施要点
- 彻底删除所有构建产物和缓存
- 重新安装依赖以确保环境一致性
- 正确的Chrome扩展重载流程
- 功能验证确保修复生效

# Implementation Plan (Generated by PLAN mode)

## Phase 1: 彻底清理项目环境 (优先级: 关键)
1. **删除旧的构建产物**
   - 在项目根目录下，手动删除整个 `dist` 文件夹
   - 验证删除完成

2. **删除依赖缓存**
   - 在项目根目录下，手动删除整个 `node_modules` 文件夹
   - 删除 `package-lock.json` 文件，确保依赖关系被重新解析

3. **清理Vite缓存**
   - 删除可能存在的 `.vite` 缓存目录
   - 验证清理完成

## Phase 2: 重新构建项目 (优先级: 高)
4. **安装全新依赖**
   - 在项目根目录的终端中，运行 `npm install`
   - 验证依赖安装成功

5. **执行干净构建**
   - 在依赖安装完成后，运行 `npm run build`
   - 验证构建成功，检查新生成的 `dist` 目录

## Phase 3: 正确重载扩展 (优先级: 高)
6. **移除旧扩展**
   - 导航到 `chrome://extensions` 页面
   - 找到 "LanGear" 扩展，点击 **"移除"** 按钮，将其完全删除

7. **加载新扩展**
   - 点击 "加载已解压的扩展程序" 按钮
   - 选择刚刚在 Phase 2 中新生成的 `dist` 文件夹

## Phase 4: 功能验证 (优先级: 中)
8. **测试API密钥验证**
   - 打开设置页面，输入Gemini API密钥并进行验证
   - 验证 `window is not defined` 错误不再出现

9. **验证AI制卡功能**
   - 测试批量导入页面的AI处理功能
   - 确认错误信息更精确和可操作

## Phase 5: 文档和总结 (优先级: 低)
10. **创建实施总结文档**
    - 记录修复过程和经验教训
    - 提供未来避免类似问题的指导

11. **代码清理**
    - 删除任何临时测试文件
    - 确保代码库整洁

## 具体执行命令
```bash
# Phase 1: 清理环境
rm -rf dist
rm -rf node_modules
rm -f package-lock.json

# Phase 2: 重建项目
npm install
npm run build

# Phase 3: 重载扩展（手动操作）
# 1. 打开 chrome://extensions
# 2. 移除旧扩展
# 3. 加载新的 dist 文件夹

# Phase 4: 功能验证（手动操作）
# 1. 测试设置页面API密钥验证
# 2. 测试批量导入AI功能
``` 