# Context
Filename: task-45-apply-fixes-to-task-mode-ui.md
Created On: 2024-12-19
Created By: AI Assistant
Associated Protocol: RIPER-5 + Sequential Thinking + Agent Protocol

# Task Description
用户报告在修复了Task 43和44的bug后，复习界面依然存在HTML标签显示、无法编辑和无法导航的问题。经过研究发现，之前的修复仅应用于"复习模式"(Review Mode)，而用户实际遇到问题的是"任务模式"(Task Mode)。

此任务的目的是：
1. 添加模式状态指示器，让用户清楚当前处于哪种模式
2. 将之前的所有修复（HTML渲染、编辑功能、导航功能）应用到"任务模式"的用户界面上

# Project Overview
这是一个React + TypeScript的语言学习扩展项目。需要确保新卡片学习流程("任务模式")和旧卡片复习流程("复习模式")具有一致的用户体验和功能。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
## 根本原因
- 系统存在两种独立的复习UI：`renderReviewInterface` (复习模式) 和 `renderTaskInterface` (任务模式)
- `renderTaskInterface` 使用的组件是 `TaskDisplay` 和 `TaskControls`
- `TaskDisplay` 直接以文本形式渲染卡片内容，导致HTML标签未被解析
- `TaskControls` 缺少编辑和导航按钮
- `Review.tsx` 的主逻辑没有为任务模式启用侧边栏编辑和导航功能
- 用户无法区分当前处于任务模式还是复习模式

## 待修复组件
- `src/main/components/review/TaskDisplay.tsx`: 修复HTML渲染
- `src/main/components/review/TaskControls.tsx`: 添加编辑和导航按钮
- `src/main/pages/Review.tsx`: 为任务模式集成编辑和导航的后台逻辑，添加模式指示器

# Proposed Solution (Populated by INNOVATE mode)
## 解决方案方向
采用与复习模式一致的解决方案，将功能模块化，并应用到任务模式中。
1. **模式指示器**: 在界面顶部添加清晰的模式状态徽章
2. **HTML渲染**: 在 `TaskDisplay.tsx` 中使用 `dangerouslySetInnerHTML`
3. **编辑功能**: 
   - 在 `TaskControls.tsx` 中添加"编辑"按钮
   - 在 `Review.tsx` 中，允许在 `task-question` 状态下通过 `handleEditCard` 打开侧边栏
   - 确保 `SidePanel` 组件在任务模式下也能正确显示和保存
4. **导航功能**:
   - 在 `TaskControls.tsx` 中添加"上一张"和"下一张"按钮
   - 将 `onPreviousCard` 和 `onNextCard` 回调函数传递给 `TaskControls`
   - 确保导航逻辑（如自动保存、重置状态）在任务模式下同样有效

# Implementation Plan (Generated by PLAN mode)
## 执行清单

### Phase 1: 添加模式状态指示器
- [ ] 1.1 检查 `Review.tsx` 中的 `renderTaskInterface` 和 `renderReviewInterface` 函数
- [ ] 1.2 在两个渲染函数中添加模式状态徽章
- [ ] 1.3 为任务模式和复习模式设置不同的颜色和样式

### Phase 2: 修复HTML渲染问题
- [ ] 2.1 读取 `src/main/components/review/TaskDisplay.tsx` 文件
- [ ] 2.2 修改 `TaskDisplay.tsx`，使用 `dangerouslySetInnerHTML` 渲染中文内容
- [ ] 2.3 创建测试验证HTML渲染修复

### Phase 3: 添加编辑功能
- [ ] 3.1 读取 `src/main/components/review/TaskControls.tsx` 文件
- [ ] 3.2 在 `TaskControls.tsx` 中添加"编辑"按钮
- [ ] 3.3 修改 `Review.tsx`，将 `handleEditCard` 函数传递给 `TaskControls`
- [ ] 3.4 修改 `Review.tsx` 的键盘事件监听，允许在 `task-question` 状态下按 'E' 键打开编辑面板
- [ ] 3.5 确保 `SidePanel` 在任务模式下正确渲染

### Phase 4: 添加导航功能
- [ ] 4.1 在 `TaskControls.tsx` 中添加"上一张"和"下一张"按钮
- [ ] 4.2 修改 `Review.tsx`，将 `handlePreviousCard` 和 `handleNextCard` 函数传递给 `TaskControls`
- [ ] 4.3 确保导航按钮的 `disabled` 状态能正确传递和使用

### Phase 5: 验证和总结
- [ ] 5.1 运行所有相关测试，确保没有功能退化
- [ ] 5.2 运行 `npm run build` 确保构建成功
- [ ] 5.3 更新任务文档记录修复过程
