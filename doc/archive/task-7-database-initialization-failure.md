# Context
Filename: task-7-database-initialization-failure.md
Created On: 2025-06-06 18:45
Created By: Claude 4 Sonnet
Associated Protocol: RIPER-5 + Sequential Thinking + Agent Protocol

# Task Description
**P1 CRITICAL:** 修复Chrome扩展数据库初始化失败导致所有数据库操作返回"Database not initialized"错误的问题。

**错误症状:**
- API调用失败：GET_ALL_DECKS, CREATE_DECK, GET_DUE_CARDS等
- 错误消息："Database not initialized. Call initDatabase() first."
- 用户无法使用任何核心功能（创建牌组、加载数据等）

**影响范围:**
- 所有数据库相关功能完全不可用
- 用户体验严重损坏
- 应用程序处于不可用状态

# Project Overview
LanGear Chrome扩展使用Service Worker后台脚本和IndexedDB进行数据持久化。当前的初始化机制依赖Chrome的onStartup/onInstalled事件，但这些事件可能在某些情况下不触发，导致数据库未初始化而消息处理器仍然尝试处理请求。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## Root Cause Analysis

### Primary Issue: Chrome Extension Event Lifecycle Problems
1. **Event Handler Dependency:** 当前初始化完全依赖Chrome的`onStartup`和`onInstalled`事件
2. **Service Worker特性:** Chrome Service Worker可能在不触发这些事件的情况下开始处理消息
3. **缺乏Fallback机制:** 没有自动初始化或重试机制

### Secondary Issue: Message Handler Design Flaw
1. **无状态检查:** `handleMessage`方法不检查`this.initialized`状态
2. **直接数据库调用:** 直接使用`dbService`而不确保其已初始化
3. **错误传播:** `ensureDatabase()`抛出的错误直接传播给用户

### Code Flow Analysis
```
用户操作 → API调用 → chrome.runtime.sendMessage → BackgroundService.handleMessage 
→ dbService.方法 → ensureDatabase() → 抛出"Database not initialized"错误
```

### Critical Files Involved
- `src/background/index.ts`: BackgroundService类和事件监听器
- `src/background/db.ts`: DatabaseService类和ensureDatabase方法
- Chrome Extension事件系统: onStartup, onInstalled, onMessage

# Proposed Solution (Populated by INNOVATE mode)

## Solution Approach: Lazy Initialization with Auto-Recovery

### Strategy 1: Message-Level Initialization Check (Recommended)
**概念:** 在每个消息处理前检查初始化状态，如果未初始化则自动初始化
**优点:** 
- 确保数据库在需要时总是可用
- 处理所有edge cases
- 保持现有API接口不变
**缺点:** 
- 每次消息处理都有微小的检查开销

### Strategy 2: Database-Level Lazy Initialization
**概念:** 在`ensureDatabase`方法中添加自动初始化逻辑
**优点:** 
- 在数据库层面解决问题
- 更少的代码重复
**缺点:** 
- 可能影响数据库操作的错误语义
- 初始化失败处理更复杂

### Strategy 3: Hybrid Approach (Selected)
**概念:** 结合消息级检查和数据库级懒加载
- 消息处理器确保服务已初始化
- 数据库服务提供懒加载机制
- 添加重试和错误恢复逻辑

# Implementation Plan (Generated by PLAN mode)

## Part 1: Enhanced Message Handler (Priority 1)

### Subtask 7.1: Add Initialization Check to Message Handler ✅
**Files:** `src/background/index.ts`
- [x] 在`handleMessage`方法开头添加初始化状态检查
- [x] 如果未初始化，调用`this.initializeWithRetry()`方法
- [x] 添加初始化重试逻辑（最多3次）
- [x] 添加特殊错误处理和用户友好的错误消息

### Subtask 7.2: Improve Initialization Error Handling ✅
**Files:** `src/background/index.ts`
- [x] 在`initializeWithRetry()`方法中添加更详细的错误日志
- [x] 添加初始化失败时的用户友好错误消息
- [x] 实现初始化状态的公共访问器（isInitialized getter）
- [x] 添加特殊错误处理（数据库未初始化、初始化失败等）

## Part 2: Database Service Enhancement (Priority 2)

### Subtask 7.3: Add Lazy Loading to Database Service
**Files:** `src/background/db.ts`
- [ ] 修改`ensureDatabase`方法支持自动初始化
- [ ] 添加初始化状态锁，防止并发初始化
- [ ] 实现初始化重试机制
- [ ] 添加数据库连接健康检查

### Subtask 7.4: Enhanced Error Messages and Recovery
**Files:** `src/background/db.ts`
- [ ] 改进错误消息提供更多上下文信息
- [ ] 添加数据库重置和重新创建功能
- [ ] 实现初始化失败的自动恢复策略

## Part 3: Chrome Extension Lifecycle Improvements (Priority 3)

### Subtask 7.5: Enhanced Event Handling ✅
**Files:** `src/background/index.ts`
- [x] 添加额外的初始化触发点（startup, installed事件增强错误处理）
- [x] 添加定期健康检查机制（每30分钟检查一次）
- [x] 实现健康检查中的自动恢复逻辑
- [x] 增强事件监听器的错误处理

### Subtask 7.6: Fallback Initialization Mechanisms ✅
**Files:** `src/background/index.ts`
- [x] 添加首次消息处理时的强制初始化（lazy loading）
- [x] 实现用户操作触发的初始化检查（每个API调用前检查）
- [x] 添加健康检查定时任务作为后备机制

## Part 4: Testing and Validation (Priority 4)

### Subtask 7.7: Comprehensive Testing
- [ ] 测试各种Chrome Extension启动场景
- [ ] 验证初始化失败和恢复机制
- [ ] 测试并发消息处理期间的初始化
- [ ] 验证用户友好的错误消息
- [ ] 测试Service Worker重启场景

### Subtask 7.8: Performance and Reliability Testing
- [ ] 验证初始化检查的性能影响
- [ ] 测试长时间运行的稳定性
- [ ] 验证内存泄漏和资源清理
- [ ] 测试极端情况下的恢复能力

---

**Priority:** P1 Critical
**Estimated Time:** 2-3 hours
**Risk Level:** Low (defensive programming, minimal API changes)
**Dependencies:** None

**Testing Commands:**
```bash
# Build and test
npm run build

# Manual testing in Chrome Extension environment
# 1. 加载扩展
# 2. 模拟各种启动条件
# 3. 验证数据库操作正常工作
# 4. 测试错误恢复机制
``` 