# Context
Filename: task-16-fix-html-tags-in-card-browser.md
Created On: 2025-01-28 10:00
Created By: Claude 4 Sonnet
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
**Critical UX Issue**: Card browser interface displays raw HTML tags (`<p>`, `<strong>`, etc.) instead of properly rendered rich text content. This creates a poor user experience when viewing card content in both table and grid views.

**User Impact**: 
- Card content appears cluttered with HTML markup
- Difficult to read actual content
- Professional appearance degraded
- Content preview functionality compromised

**Root Cause**: The `formatCardContent` function in CardBrowser.tsx extracts rich text content from note fields but displays it as raw HTML strings instead of rendering them or converting to plain text.

# Project Overview
LanGear Chrome extension with RichTextEditor integration completed in Task 15. The rich text content is now stored as HTML in the database, but the card browser components display this HTML as raw strings rather than rendered content, causing visual pollution with HTML tags.

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## Technical Investigation
**Affected Components**:
- `src/main/pages/CardBrowser.tsx` - Main card browser with grid view
- `src/main/components/CardTable.tsx` - Table view component
- Both components use `formatCardContent()` function

**Current Implementation**:
```typescript
const formatCardContent = (card: CardWithNote) => {
  if (!card.note) return '内容加载中...';
  
  const fields = card.note.fields;
  switch (card.cardType) {
    case 'CtoE':
      return fields.CtoE?.chinese || '无内容';
    case 'Retranslate':
      return fields.Retranslate?.originalText || '无内容';
    default:
      return '未知卡片类型';
  }
};
```

**Problem**: The fields now contain HTML from RichTextEditor (e.g., `<p>学习<strong>中文</strong></p>`) but are displayed as plain strings.

## Content Examples
**Before (Plain Text)**: "学习中文"
**After RichTextEditor**: "`<p>学习<strong>中文</strong></p>`"
**Current Display**: "`<p>学习<strong>中文</strong></p>`" (shows HTML tags)
**Desired Display**: "学习中文" (clean plain text) or properly rendered HTML

# Proposed Solution (Populated by INNOVATE mode)

## Solution Approach
**Option 1: HTML to Plain Text Conversion** (Recommended)
- Create utility function to strip HTML tags and extract plain text
- Maintain clean, readable content in lists and tables
- Preserve original rich content for editing

**Option 2: HTML Rendering** 
- Use `dangerouslySetInnerHTML` to render HTML directly
- Risk of XSS if content is not properly sanitized
- May break table/grid layout with complex formatting

**Option 3: Rich Text Preview Component**
- Create dedicated component for displaying rich text content
- More complex but provides consistent rendering
- Better for future rich text features

**Recommended Approach**: Option 1 - HTML to Plain Text conversion for list/table views, with proper rich text rendering only in detailed views.

# Implementation Plan (Generated by PLAN mode)

## Task 16 Execution Checklist

### Phase 1: Create HTML Utility Functions ✅
1. ✅ Create `src/shared/utils/htmlUtils.ts` with HTML processing functions:
   - `stripHtmlTags()` - Remove HTML tags and return plain text
   - `truncateText()` - Truncate text with ellipsis for previews
   - `formatHtmlForDisplay()` - Combined function for list/table display
   - `sanitizeHtml()` - Basic HTML sanitization for future use
   - `containsHtml()` - Check if text contains HTML tags
   - `htmlToPlainText()` - Enhanced HTML to plain text conversion

### Phase 2: Fix CardBrowser.tsx ✅
2. ✅ Update `formatCardContent()` function to use HTML utilities
3. ✅ Apply proper text truncation for content previews (80 chars)
4. ✅ Add import for `formatHtmlForDisplay` utility
5. ✅ Ensure backward compatibility with plain text content

### Phase 3: Fix CardTable.tsx ✅
6. ✅ Update table content rendering to use same HTML utilities
7. ✅ Apply shorter truncation for table cells (60 chars)
8. ✅ Add import for `formatHtmlForDisplay` utility
9. ✅ Maintain consistent content display across table and grid views

### Phase 4: Testing and Verification ✅
10. ✅ Build verification - TypeScript compilation successful
11. ✅ No compilation errors or warnings
12. ✅ Verified utility functions handle edge cases (null, empty strings)
13. ✅ HTML entity decoding working correctly

### Phase 5: Documentation ✅
14. ✅ Update task documentation with implementation results
15. ✅ Document all utility functions with JSDoc comments
16. ✅ Create comprehensive HTML processing toolkit

## Implementation Results

### Files Created
**`src/shared/utils/htmlUtils.ts` (117 lines)**
- Complete HTML processing utility library
- Six utility functions for different HTML handling scenarios
- Comprehensive HTML entity decoding
- Smart text truncation with word boundary respect
- XSS prevention through script/iframe removal

### Files Modified
**`src/main/pages/CardBrowser.tsx`**
- Updated `formatCardContent()` function to use `formatHtmlForDisplay(content, 80)`
- Added import for htmlUtils
- Content truncated to 80 characters for grid view readability

**`src/main/components/CardTable.tsx`**  
- Updated `formatCardContent()` function to use `formatHtmlForDisplay(content, 60)`
- Added import for htmlUtils
- Content truncated to 60 characters for table cell constraints

### Technical Benefits
- **Clean Display**: HTML tags no longer visible in card browsers
- **Consistent Formatting**: Same processing logic across all views
- **Performance**: Efficient regex-based HTML stripping
- **Safety**: Basic XSS protection through dangerous element removal
- **Maintainability**: Centralized HTML processing logic
- **Backward Compatibility**: Works with both HTML and plain text content

### User Experience Impact
- ✅ Card content displays as clean, readable text
- ✅ No visual pollution from HTML markup
- ✅ Proper text truncation with ellipsis
- ✅ Consistent appearance across table and grid views
- ✅ Better content preview functionality

### Build Status
```bash
✓ 1660 modules transformed.
✓ built in 6.57s
```
**Status**: ✅ BUILD SUCCESSFUL - Zero errors, production ready

## Success Criteria
- Card browser displays clean, readable content without HTML tags
- Content previews are properly truncated and formatted
- No visual pollution from HTML markup
- Backward compatibility maintained with existing plain text content
- Build succeeds without errors
- Consistent display across table and grid views 