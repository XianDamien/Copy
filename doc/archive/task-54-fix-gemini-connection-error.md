# Context
Filename: task-54-fix-gemini-connection-error.md
Created On: 2024-12-19
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
修复在Chrome扩展后台脚本中调用Gemini API时出现的"网络连接错误"。根本原因是 `@google/generative-ai` SDK与Service Worker环境不兼容，导致了 `ReferenceError: window is not defined` 错误。

# Project Overview
LanGear是一款基于Chrome扩展的语言学习工具，采用双相学习系统（任务阶段+复习阶段）。当前AI制卡功能因底层SDK与扩展环境冲突而无法正常工作，影响了智能双语对齐与格式化功能。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## 问题诊断
- **根本原因**: `src/background/geminiService.ts` 中使用的 `@google/generative-ai` SDK 内部依赖 `window` 对象，而Chrome扩展的Service Worker执行环境中不存在该对象，导致代码在发起网络请求前就已崩溃
- **错误表现**: `ReferenceError: window is not defined` 在后台脚本中抛出
- **影响范围**: 
  - 设置页面的API密钥验证功能失效
  - 批量导入页面的AI处理功能失效
  - 用户看到通用的"网络连接错误"提示

## 当前架构优势
- **正确的设计**: 将API调用置于后台脚本中是正确的设计，有效避免了CORS问题和API密钥在客户端暴露的安全风险
- **符合最佳实践**: 架构符合用户提供的系统性指南中关于使用代理服务器的建议

## 技术约束
- Chrome扩展Service Worker环境不支持DOM API
- 需要保持与现有UI组件的兼容性
- 必须维护现有的错误处理和用户反馈机制

# Proposed Solution (Populated by INNOVATE mode)

## 推荐方案: 重构为原生fetch API实现
**核心策略**: 彻底移除 `@google/generative-ai` SDK，改用浏览器原生的 `fetch` API直接调用Gemini REST API

### 优势分析
1. **解决核心问题**: 从根本上消除了对 `window` 对象的依赖
2. **轻量化**: 无需引入外部SDK，减少了插件的体积和依赖复杂性
3. **完全可控**: 对请求和响应的处理具有完全的控制权，便于实现精细的错误处理和日志记录
4. **符合指南**: 与用户提供的API调用剖析指南高度契合

### 实现要点
- 使用Gemini REST API的 `generateContent` 端点
- 实现健壮的HTTP状态码错误处理
- 保持现有的业务逻辑和接口契约
- 增强错误信息的具体性和可操作性

# Implementation Plan (Generated by PLAN mode)

## Phase 1: 核心服务重构
1. **分析Gemini REST API规范**
   - 研究官方API文档和端点结构
   - 确定请求格式和认证方式
   - 验证错误响应格式

2. **重构 `geminiService.ts`**
   - 移除 `@google/generative-ai` SDK依赖
   - 实现基于fetch的 `validateApiKey` 方法
   - 实现基于fetch的 `processTextForCards` 方法
   - 增强错误处理逻辑

3. **清理项目依赖**
   - 从package.json中移除SDK依赖
   - 更新依赖锁定文件

## Phase 2: 功能验证与测试
4. **创建测试用例**
   - 编写API密钥验证测试
   - 编写文本处理功能测试
   - 验证错误处理场景

5. **端到端功能验证**
   - 测试设置页面的API密钥验证
   - 测试批量导入页面的AI处理功能
   - 验证错误信息的准确性

## Phase 3: 文档和清理
6. **创建实施总结文档**
   - 记录修复过程和技术细节
   - 总结经验教训
   - 提供维护指导

7. **代码清理**
   - 删除临时测试文件
   - 整理代码结构
   - 更新相关注释

## 执行状态

### Phase 1: 核心服务重构 ✅
1. **分析Gemini REST API规范** ✅
2. **重构 `geminiService.ts`** ✅
3. **清理项目依赖** ✅

### Phase 2: 功能验证与测试 ✅
4. **创建测试用例** ✅
5. **端到端功能验证** ✅

### Phase 3: 文档和清理 ✅
6. **创建实施总结文档** ✅
7. **代码清理** ✅

## 任务完成总结

**状态**: ✅ 全部完成  
**修复结果**: 🎯 成功解决Gemini API连接错误  
**技术债务**: 📉 减少（移除不兼容SDK依赖）  
**用户体验**: 📈 改善（错误信息更精确）  
**维护成本**: 📉 降低（使用原生API）

**详细实施报告**: 参见 `doc/issues/task-54-fix-gemini-connection-error-implementation-summary.md` 