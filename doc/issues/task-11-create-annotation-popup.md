# Context
Filename: task-11-create-annotation-popup.md
Created On: 2025-01-27 23:00
Created By: Claude 4 Sonnet
Associated Protocol: RIPER-5 + Sequential Thinking + Agent Protocol

# Task Description
Create a comprehensive Multi-State Annotation Popup component that replaces the placeholder popup in InteractiveEditor.tsx. This popup manages the complete annotation workflow with three distinct views:

1. **Choice View**: Initial selection between "Define Manually" and "Ask AI"
2. **Manual Form View**: User input form for definition, grammar notes, and personal notes
3. **AI Chat View**: Placeholder interface for AI-assisted annotation (Phase 2 integration)

# Project Overview
This task is part of Phase 1 of the Interactive Editor Foundation. The AnnotationPopup component will serve as the primary interface for users to create, edit, and manage word annotations within the rich text editor. It must integrate seamlessly with the existing InteractiveEditor component and follow the industrial theme design principles.

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## Current State Analysis
- **InteractiveEditor.tsx**: Has placeholder popup at lines 266-278 that needs replacement
- **WordAnnotation Interface**: Well-defined with id, word, definition, grammar, notes, timestamps
- **State Management**: Editor manages annotations, activeAnnotationId, isPopupOpen states
- **Integration Points**: 
  - onAnnotationClick handler triggers popup opening
  - createAnnotation creates new annotations with nanoid IDs
  - Editor passes annotation data to popup

## Component Requirements
- **Props Interface**: Must accept annotation data, callbacks for save/cancel/delete
- **State Management**: Internal state for current view, form data, validation
- **View Transitions**: Smooth navigation between choice, manual, and AI views
- **Industrial Theme**: Consistent styling with existing design system
- **Responsive Design**: Mobile-friendly modal with proper positioning

## Integration Dependencies
- **InteractiveEditor.tsx**: Needs to import and use AnnotationPopup
- **Types**: WordAnnotation interface from shared/types
- **Styling**: Industrial theme variables and components
- **Icons**: Lucide icons for UI elements

# Proposed Solution (Populated by INNOVATE mode)

## Multi-View Architecture
**Choice View (Initial)**:
- Two prominent buttons: "手动定义" (Manual) and "AI 辅助" (AI Assist)
- Show selected word prominently
- Quick context display

**Manual Form View**:
- Definition input (required)
- Grammar notes input (optional)
- Personal notes textarea (optional)
- Save/Cancel/Delete actions
- Form validation and error handling

**AI Chat View (Placeholder)**:
- Placeholder interface showing "AI 功能即将推出"
- Back button to return to choice view
- Prepared structure for Phase 2 integration

## State Management Strategy
- Use React useState for view state ('choice' | 'manual' | 'ai')
- Form state management with controlled inputs
- Validation state for required fields
- Loading states for future AI integration

## UI/UX Design
- Modal overlay with backdrop blur
- Centered modal with max-width constraint
- Smooth view transitions with fade effects
- Clear visual hierarchy and typography
- Consistent button styles and spacing

# Implementation Plan (Generated by PLAN mode)

## Subtask 11.1: Create AnnotationPopup Component Structure
**Files**: `src/main/components/editor/AnnotationPopup.tsx`
- [ ] Create component file with TypeScript interface
- [ ] Define props interface (annotation, onSave, onCancel, onDelete)
- [ ] Set up multi-view state management
- [ ] Implement modal structure with backdrop
- [ ] Add industrial theme styling foundation

**Testing Command**: `npm run build && npm run test:annotation-popup`

## Subtask 11.2: Implement Choice View
**Files**: `src/main/components/editor/AnnotationPopup.tsx`
- [ ] Create choice view UI with two main buttons
- [ ] Display selected word/phrase prominently
- [ ] Add context information display
- [ ] Implement navigation to manual/AI views
- [ ] Style with industrial theme components

**Testing Command**: `npm run build && npm run test:choice-view`

## Subtask 11.3: Build Manual Form View
**Files**: `src/main/components/editor/AnnotationPopup.tsx`
- [ ] Create form with definition input (required)
- [ ] Add grammar notes input (optional)
- [ ] Implement personal notes textarea
- [ ] Add form validation and error states
- [ ] Create save/cancel/delete action buttons
- [ ] Handle form submission and data validation

**Testing Command**: `npm run build && npm run test:manual-form`

## Subtask 11.4: Create AI Chat Placeholder View
**Files**: `src/main/components/editor/AnnotationPopup.tsx`
- [ ] Design placeholder UI for AI chat interface
- [ ] Add "功能即将推出" message with icon
- [ ] Implement back navigation to choice view
- [ ] Prepare structure for Phase 2 AI integration
- [ ] Style consistently with industrial theme

**Testing Command**: `npm run build && npm run test:ai-placeholder`

## Subtask 11.5: Integrate with InteractiveEditor
**Files**: `src/main/components/editor/InteractiveEditor.tsx`
- [ ] Import AnnotationPopup component
- [ ] Replace placeholder popup with AnnotationPopup
- [ ] Pass annotation data and callbacks
- [ ] Handle save/cancel/delete actions
- [ ] Update annotation state management
- [ ] Test complete annotation workflow

**Testing Command**: `npm run build && npm run test:editor-integration`

---

**Priority**: P0 Critical (Required for Phase 1 completion)
**Estimated Time**: 4-6 hours
**Risk Level**: Medium (Complex state management and UI transitions)
**Dependencies**: Existing InteractiveEditor, WordAnnotation types, Industrial theme 