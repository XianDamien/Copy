# Context
Filename: task-10-interactive-editor-with-ai-annotations.md
Created On: 2024-12-19
Created By: Claude AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
Replace the current static form-based note editor with an interactive rich text editor that supports:
1. Real-time text annotation with word/phrase-level popups
2. AI-powered definition and grammar assistance (DeepSeek + Gemini integration)
3. Manual annotation with preset grammar rules
4. Floating toolbar for seamless annotation workflow
5. Industrial-themed UI design consistent with existing codebase

Key UI Requirements:
- TipTap rich text editor as foundation
- Floating toolbar appears on text selection with "Annotate" button
- Multi-state popup: "Define Manually" vs "Ask AI" initial choice
- Support for both DeepSeek and Gemini AI providers
- Preset grammar rules integration
- Industrial color scheme and styling

# Project Overview
AnGear Language Learning Extension - Chrome extension for intelligent language learning with FSRS algorithm integration. Current note editor uses basic textarea/input fields. New editor will enable advanced interactive learning with AI assistance and rich annotations.

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
- Current NoteEditor.tsx uses basic form inputs (textarea for Chinese/English, input for pinyin/notes)
- Existing industrial theme defined in tailwind.config.js with primary/accent color schemes
- Type system in src/shared/types.ts currently supports CtoE note type only
- Chrome extension architecture supports content scripts and background services
- API client infrastructure exists for backend communication

Key Files Identified:
- src/main/pages/NoteEditor.tsx (current implementation - needs complete refactor)
- src/shared/types.ts (needs new RichContent note type)
- tailwind.config.js (industrial theme colors for styling)
- src/shared/utils/api.ts (API client for backend communication)

Technical Constraints:
- Must maintain Chrome extension compatibility
- Need to preserve existing FSRS card creation workflow
- Industrial theme consistency required
- Multi-language support essential

# Proposed Solution (Populated by INNOVATE mode)
Selected TipTap as rich text editor foundation due to:
- React integration and extensibility
- Custom mark/extension system for annotations
- BubbleMenu support for floating toolbar
- JSON-based content storage (fits existing data model)

Hybrid AI approach chosen:
- Static user annotations for offline functionality
- AI lookup integration for enhanced definitions
- Preset grammar rules for common patterns
- User choice between manual and AI-assisted annotation

Multi-provider AI strategy:
- Support both DeepSeek and Gemini APIs
- User-configurable default provider
- Fallback handling for API failures
- Secure API key storage in Chrome storage

# Implementation Plan (Generated by PLAN mode)

## Phase 1: Core Interactive Editor Foundation

### Task 1: Setup Dependencies and Update Type Definitions ✅
- [x] Add TipTap dependencies (@tiptap/react, @tiptap/core, @tiptap/starter-kit, @tiptap/extension-bubble-menu)
- [x] Update src/shared/types/index.ts with WordAnnotation and RichContentNoteFields interfaces
- [x] Add RichContent to NoteFields union type
- [x] Add AI provider types (AIProvider, AIProviderConfig, AIDefinitionRequest/Response)
- [x] Test command: `npm run build` (verify no TypeScript errors) ✅

### Task 2: Create TipTap Custom Mark Extension ✅
- [x] Create src/main/components/editor/AnnotatedWordMark.ts
- [x] Implement TipTap Mark with annotation ID attribute  
- [x] Add industrial-themed styling for annotated words
- [x] Implement onClick handler for annotation popup trigger
- [x] Add event management and cleanup systems
- [x] Test command: `npm run build` ✅ (verified compilation)

### Task 3: Build Interactive Editor Component ✅
- [x] Create src/main/components/editor/InteractiveEditor.tsx
- [x] Initialize TipTap with StarterKit and custom AnnotatedWordMark
- [x] Implement BubbleMenu with "Annotate" button
- [x] Add state management for content and annotations
- [x] Handle text selection and annotation creation
- [x] Add industrial-themed UI with toolbar and status bar
- [x] Implement save/reset functionality and loading states
- [x] Test command: `npm run build` ✅ (verified compilation)

### Task 4: Create Multi-State Annotation Popup ⏳
- [ ] Create src/main/components/editor/AnnotationPopup.tsx
- [ ] Implement View 1: Initial choice ("Define Manually" vs "Ask AI")
- [ ] Implement View 2: Manual editor form (definition, grammar, notes)
- [ ] Implement View 3: AI chat interface (placeholder for Phase 2)
- [ ] Add industrial theme styling
- [ ] Test command: `npm run test:unit src/main/components/editor/AnnotationPopup.test.tsx`

### Task 5: Refactor Note Editor Page ⏳
- [ ] Update src/main/pages/NoteEditor.tsx to use InteractiveEditor
- [ ] Remove old textarea/input elements
- [ ] Update handleSave for RichContent note type
- [ ] Maintain backward compatibility with CtoE notes
- [ ] Test command: `npm run test:integration NoteEditor.test.tsx`

## Phase 2: AI and Hybrid Data Integration

### Task 6: API Key Management ⏳
- [ ] Update src/options/OptionsApp.tsx with AI Settings section
- [ ] Add DeepSeek and Gemini API key inputs
- [ ] Add default provider selection dropdown
- [ ] Implement secure storage with chrome.storage.local
- [ ] Test command: `npm run test:unit src/options/OptionsApp.test.tsx`

### Task 7: Multi-Provider AI Service ⏳
- [ ] Create src/shared/utils/aiService.ts
- [ ] Implement DeepSeek API integration
- [ ] Implement Gemini API integration
- [ ] Add provider selection and fallback logic
- [ ] Add error handling for API failures
- [ ] Test command: `npm run test:unit src/shared/utils/aiService.test.ts`

### Task 8: Activate AI Chat in Popup ⏳
- [ ] Complete View 3 implementation in AnnotationPopup.tsx
- [ ] Add loading states and error handling
- [ ] Implement "Copy to Definition/Notes" functionality
- [ ] Add follow-up question capability
- [ ] Test command: `npm run test:integration AIAnnotation.test.tsx`

### Task 9: Integrate Preset Grammar Rules ⏳
- [ ] Create src/shared/data/presetRules.json
- [ ] Add searchable preset rules in Manual Editor view
- [ ] Implement rule injection into Grammar/Notes fields
- [ ] Test command: `npm run test:unit PresetRules.test.ts`

## Phase 3: Final Polish and Review

### Task 10: Comprehensive Testing ⏳
- [ ] Write unit tests for all new components
- [ ] Write integration tests for annotation workflow
- [ ] Manual testing with both AI providers
- [ ] Performance testing with large text content
- [ ] Test command: `npm run test:coverage` (target: >80% coverage)

### Task 11: Review and Refine ⏳
- [ ] UI/UX review against industrial design principles
- [ ] Accessibility testing
- [ ] Cross-browser compatibility check
- [ ] Documentation and code cleanup
- [ ] Test command: `npm run lint && npm run build:production` 