# Context
Filename: task-9-card-browser-date-fix-and-anki-enhancement.md
Created On: 2025-01-27 20:15
Created By: Claude 4 Sonnet
Associated Protocol: RIPER-5 + Sequential Thinking + Agent Protocol

# Task Description
**Critical Bug**: Fix TypeError `j.due.getTime is not a function` causing card browser blank page
**Enhancement Goal**: Implement Anki-inspired card browser with tag filtering, advanced search, in-line editing, list view, rich text formatting, and tag management using existing card data

**User Requirements**:
- Use existing cards (confirmed data exists from previous tests)
- Tag-based filtering for organization by topics/difficulty
- Advanced search functionality for content/metadata
- In-line editing with click-to-edit functionality
- List view layout (table-style like Anki)
- Rich text formatting and tag management capabilities
- Simple approach for <100 cards performance target

# Project Overview
LanGear Chrome extension has a functional card browser that was previously implemented and tested (Task 6), but now fails due to date serialization issues. The root cause is `card.due.getTime()` being called on string values instead of Date objects. After fixing this critical bug, enhance the browser with Anki's proven UX patterns for professional card management.

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## Critical Bug Analysis
**Error Location**: `src/main/pages/CardBrowser.tsx:256`
```typescript
`${Math.ceil((card.due.getTime() - Date.now()) / (1000 * 60 * 60 * 24))}天后`
```

**Root Cause**: Date serialization issue between IndexedDB and frontend
- Database service has `convertDatesInCard()` method that should convert string dates to Date objects
- Method is called in `getCardsByDeckId()` on line 443 of `src/background/db.ts`
- Error still occurs, indicating conversion bypass or API response path issue

**Secondary Issue**: Line 295 also uses date methods:
```typescript
selectedCard.due.toLocaleDateString()
```

**Technical Investigation**:
- ✅ Navigation flow: DeckList → MainApp → CardBrowser working
- ✅ API methods: `getDeckById()` and `getCardsByDeckId()` exist
- ✅ Background handlers: Properly implemented with date conversion
- ❌ Date conversion: Not working in practice despite implementation

## Existing Card Data Research
**From Task 6 Documentation**:
- Card Browser interface previously implemented and tested ✅
- API methods `getCardsByDeckId` and `getNoteById` added ✅
- Card Browser shows: state, content preview, stats, due dates ✅
- Modal detail view implemented ✅

**Confirmed Existing Features**:
- Card state visualization (New, Learning, Review, Relearning)
- Card statistics (review count, lapses, due dates)
- Click-to-modal functionality
- Grid layout with hover actions

## Anki Enhancement Requirements
**Based on User Specifications**:
1. **Tag-based filtering**: Organize cards by topics/difficulty levels
2. **Advanced search**: Full-text search across card content and metadata
3. **In-line editing**: Direct click-to-edit without modal overlay
4. **List view**: Table-style layout with sortable columns
5. **Rich text formatting**: Bold, italic, highlighting capabilities  
6. **Tag management**: Add, remove, edit tags directly from browser
7. **Simple approach**: Optimized for <100 cards per deck

# Proposed Solution (Populated by INNOVATE mode)

## Bug Fix Strategy
**Primary Approach: API Response Date Conversion**
- Investigate actual API response structure
- Ensure date conversion happens at message boundary
- Add fallback date parsing in CardBrowser component

**Alternative: Frontend Date Parsing**
- Add safe date parsing utilities in CardBrowser
- Convert dates on component mount and data updates
- Maintain backward compatibility

## Enhancement Architecture
**List View Design**:
- Sortable table with columns: Content, State, Due Date, Tags, Stats
- Integrated filtering toolbar above table
- Quick actions (edit, delete) in row hover state
- Bulk selection with checkbox column

**Filtering System**:
- Tag filter dropdown with multi-select
- Card state filter (New/Learning/Review/etc.)
- Due date range picker
- Full-text search input
- Filter combination logic

**In-line Editing**:
- Click cell to enter edit mode
- Rich text editor for content fields
- Tag editor with autocomplete
- Auto-save on blur with change validation

# Implementation Plan (Generated by PLAN mode)

## Phase 1: Critical Bug Fix (Priority P0)

### Subtask 9.1: Debug Date Conversion Issue
**Files**: `src/main/pages/CardBrowser.tsx`, background debugging
- [ ] Add console logging to track API response data structure
- [ ] Verify `convertDatesInCard` method execution in background script
- [ ] Test API response with minimal dataset
- [ ] Identify exact point where date conversion fails

### Subtask 9.2: Implement Safe Date Parsing
**Files**: `src/main/pages/CardBrowser.tsx`, `src/shared/utils/dateUtils.ts`
- [ ] Create utility function for safe date parsing
- [ ] Add date conversion to CardBrowser component data processing
- [ ] Replace all `card.due.getTime()` calls with safe date handling
- [ ] Test with existing card data to ensure no regressions

### Subtask 9.3: Enhanced Error Handling
**Files**: `src/main/pages/CardBrowser.tsx`
- [ ] Add try-catch blocks around date operations
- [ ] Implement fallback display for invalid dates
- [ ] Add user-friendly error messages
- [ ] Create loading skeleton during data processing

## Phase 2: List View Implementation (Priority P1)

### Subtask 9.4: Table Layout Component
**Files**: `src/main/components/CardTable.tsx`, styling updates
- [ ] Create sortable table component with columns:
  - Content preview (main field)
  - Card state with color coding
  - Due date (formatted, sortable)
  - Tags (clickable, editable)
  - Review stats (reps, lapses)
  - Quick actions (edit, delete)
- [ ] Implement column sorting with direction indicators
- [ ] Add responsive design for mobile compatibility
- [ ] Style with industrial theme consistency

### Subtask 9.5: Advanced Filtering System
**Files**: `src/main/components/CardFilters.tsx`
- [ ] Tag filter: Multi-select dropdown with existing tags
- [ ] State filter: Checkbox group for New/Learning/Review/etc.
- [ ] Due date filter: Date range picker component
- [ ] Search input: Full-text search across content and metadata
- [ ] Filter reset button and active filter indicators
- [ ] URL parameter persistence for filter state

## Phase 3: In-line Editing Features (Priority P1)

### Subtask 9.6: Click-to-Edit Implementation  
**Files**: `src/main/components/InlineEditor.tsx`, `src/main/components/RichTextEditor.tsx`
- [ ] Create cell-based editing system
- [ ] Implement rich text editor with toolbar:
  - Bold, italic, underline formatting
  - Highlighting with color options
  - Undo/redo functionality
- [ ] Add auto-save mechanism with debouncing
- [ ] Validation and error handling for field updates

### Subtask 9.7: Tag Management Interface
**Files**: `src/main/components/TagEditor.tsx`
- [ ] Inline tag editing with add/remove buttons
- [ ] Tag autocomplete from existing tags in deck
- [ ] Bulk tag operations (add tag to selected cards)
- [ ] Tag color coding and organization
- [ ] Tag usage statistics and suggestions

## Phase 4: Enhanced User Experience (Priority P2)

### Subtask 9.8: Bulk Operations
**Files**: `src/main/components/BulkActions.tsx`
- [ ] Multi-select checkbox column
- [ ] Bulk state changes (suspend, unsuspend, reset)
- [ ] Bulk tag operations (add, remove tags)
- [ ] Bulk delete with confirmation dialog
- [ ] Select all/none functionality

### Subtask 9.9: Performance Optimization
**Files**: Various components, utility functions
- [ ] Virtual scrolling for large card lists (future-proofing)
- [ ] Debounced search to prevent excessive filtering
- [ ] Memoized filter functions and sort operations
- [ ] Lazy loading of card content details
- [ ] Pagination controls (if needed for >100 cards)

## Phase 5: Testing and Documentation (Priority P2)

### Subtask 9.10: Comprehensive Testing
- [ ] Test date parsing with various date formats
- [ ] Validate filtering accuracy with complex combinations
- [ ] Test in-line editing with different content types
- [ ] Verify tag management operations
- [ ] Performance testing with 100+ cards
- [ ] Cross-browser compatibility testing

---

**Priority**: P0 Critical (Bug Fix) → P1 High (Core Features) → P2 Medium (Enhancement)
**Estimated Time**: 10-14 hours total
- Bug fix: 2-3 hours
- List view: 4-5 hours  
- In-line editing: 3-4 hours
- Enhanced features: 1-2 hours

**Risk Level**: Medium (Complex UI changes, data integrity)
**Dependencies**: Existing card data, functional database

**Testing Commands**:
```bash
# Build and verify
npm run build

# Debug date conversion
# 1. Check background script console for API responses
# 2. Monitor CardBrowser component state changes
# 3. Test with known good card data
# 4. Verify all date operations work correctly
```

**Key Questions Answered**:
1. ✅ Use existing cards (confirmed from Task 6 documentation)
2. ✅ Tag filtering + advanced search + in-line editing (planned)
3. ✅ List view layout (table design)
4. ✅ Rich text + tag management (comprehensive editing)
5. ✅ Simple approach (<100 cards optimization) 