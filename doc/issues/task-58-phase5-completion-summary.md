# Task 58 - Phase 5: AIç¿»è¯‘ä¸éŸ³é¢‘åˆ‡åˆ†åŠŸèƒ½å®Œæˆæ€»ç»“

**ä»»åŠ¡**: Phase 5 - AIæ‰¹é‡ç¿»è¯‘å’ŒéŸ³é¢‘åˆ‡åˆ†ä¸å­˜å‚¨  
**åˆ›å»ºæ—¶é—´**: 2025å¹´7æœˆ11æ—¥  
**å®Œæˆæ—¶é—´**: 2025å¹´7æœˆ11æ—¥  
**æ‰§è¡Œæ¨¡å¼**: RIPER-5 EXECUTE MODE  

## å®ç°æ¦‚è¿°

æˆåŠŸå®Œæˆäº†éŸ³é¢‘+å­—å¹•æ‰¹é‡åˆ¶å¡åŠŸèƒ½çš„ç¬¬5é˜¶æ®µï¼šAIæ‰¹é‡ç¿»è¯‘ä¸Web Audio APIéŸ³é¢‘åˆ‡åˆ†ã€‚é€šè¿‡æ‰©å±•GeminiServiceå’Œåˆ›å»ºAudioSlicerç±»ï¼Œå®ç°äº†ä»å­—å¹•ç¿»è¯‘åˆ°éŸ³é¢‘åˆ‡åˆ†çš„å®Œæ•´å·¥ä½œæµç¨‹ï¼Œä¸ºæœ€ç»ˆçš„å¡ç‰‡ç”Ÿæˆåšå¥½å‡†å¤‡ã€‚

## Phase 5-1: æ‰¹é‡ç¿»è¯‘åŠŸèƒ½ âœ…

### æ ¸å¿ƒå®ç°
- **GeminiServiceæ‰©å±•**: æ–°å¢`translateSubtitlesBatch()`æ–¹æ³•
- **UIé›†æˆ**: AudioSubtitleImporterç»„ä»¶å®Œæ•´é›†æˆç¿»è¯‘å·¥ä½œæµ
- **ç•Œé¢é˜¶æ®µ**: ç¿»è¯‘ä¸­ç•Œé¢ã€å¡ç‰‡é¢„è§ˆç•Œé¢
- **é”™è¯¯å¤„ç†**: å¤šå±‚æ¬¡å®¹é”™å’Œfallbackæœºåˆ¶

### æŠ€æœ¯ç‰¹ç‚¹
- **æ™ºèƒ½åˆ†æ‰¹**: 5æ¡/æ‰¹æ¬¡ï¼Œé¿å…APIé™åˆ¶
- **è¿›åº¦è·Ÿè¸ª**: å®æ—¶è¿›åº¦æ˜¾ç¤ºå’Œç”¨æˆ·åé¦ˆ
- **APIå¯†é’¥ç®¡ç†**: è‡ªåŠ¨åŠ è½½ç°æœ‰é…ç½®
- **ä¸“ä¸šç¿»è¯‘**: é’ˆå¯¹å­—å¹•æ–‡æœ¬ä¼˜åŒ–çš„ç¿»è¯‘prompt

## Phase 5-2: éŸ³é¢‘åˆ‡åˆ†ä¸å­˜å‚¨ âœ…

### æ ¸å¿ƒå®ç° (src/shared/utils/audioSlicer.ts)

**AudioSlicerç±»åŠŸèƒ½**:
```typescript
interface AudioSegment {
  id: string;
  audioBlob: Blob;
  originalText: string;
  translatedText: string;
  startTime: number;
  endTime: number;
  duration: number;
}
```

**ä¸»è¦æ–¹æ³•**:
- `sliceAudioBySubtitles()`: ä¸»å…¥å£ï¼Œæ‰¹é‡åˆ‡åˆ†éŸ³é¢‘
- `decodeAudioFile()`: è§£ç éŸ³é¢‘æ–‡ä»¶ä¸ºAudioBuffer
- `sliceAudioSegment()`: ç²¾ç¡®åˆ‡åˆ†å•ä¸ªéŸ³é¢‘ç‰‡æ®µ
- `audioBufferToBlob()`: è½¬æ¢AudioBufferä¸ºBlobå­˜å‚¨
- `audioBufferToWavBlob()`: ç”ŸæˆWAVæ ¼å¼éŸ³é¢‘æ–‡ä»¶

### æŠ€æœ¯å®ç°ç»†èŠ‚

**1. éŸ³é¢‘è§£ç ä¸åˆ‡åˆ†**
```typescript
// æ—¶é—´æˆ³è½¬é‡‡æ ·ç‚¹
const startOffset = Math.round(sampleRate * startTime);
const endOffset = Math.round(sampleRate * endTime);
const frameCount = endOffset - startOffset;

// ç²¾ç¡®å¤åˆ¶éŸ³é¢‘æ•°æ®
for (let channel = 0; channel < channels; channel++) {
  const originalChannelData = audioBuffer.getChannelData(channel);
  const slicedChannelData = slicedBuffer.getChannelData(channel);
  
  for (let i = 0; i < frameCount; i++) {
    const sourceIndex = startOffset + i;
    slicedChannelData[i] = originalChannelData[sourceIndex];
  }
}
```

**2. WAVæ ¼å¼è½¬æ¢**
- å®Œæ•´çš„WAVæ–‡ä»¶å¤´ç”Ÿæˆ
- PCM 16-bitæ ¼å¼è¾“å‡º
- å¤šå£°é“æ”¯æŒ
- æ­£ç¡®çš„å­—èŠ‚åºå¤„ç†

**3. é”™è¯¯å¤„ç†ä¸éªŒè¯**
- æ—¶é—´æˆ³æœ‰æ•ˆæ€§éªŒè¯
- éŸ³é¢‘è¾¹ç•Œæ£€æŸ¥
- å•ä¸ªå¤±è´¥ä¸å½±å“æ‰¹é‡å¤„ç†
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

### æ€§èƒ½ä¼˜åŒ–

**1. å†…å­˜ç®¡ç†**
- ä½¿ç”¨OfflineAudioContextè¿›è¡Œé«˜æ•ˆæ¸²æŸ“
- åŠæ—¶é‡Šæ”¾AudioContextèµ„æº
- åˆ†ç‰‡å¤„ç†é¿å…å†…å­˜æº¢å‡º

**2. ç²¾åº¦ä¿è¯**
- æ¯«ç§’çº§æ—¶é—´æˆ³ç²¾åº¦
- é‡‡æ ·ç‡è‡ªé€‚åº”
- è¾¹ç•Œæƒ…å†µå¤„ç†

**3. å¹¶å‘å¤„ç†**
- æ”¯æŒè¿›åº¦å›è°ƒ
- å¼‚æ­¥æ“ä½œä¼˜åŒ–
- é”™è¯¯æ¢å¤æœºåˆ¶

## Context7æ·±åº¦ç ”ç©¶æˆæœ

### Web Audio APIæ ¸å¿ƒæ¦‚å¿µ
- **AudioBuffer**: éŸ³é¢‘æ•°æ®å®¹å™¨å’Œæ“ä½œ
- **AudioContext**: éŸ³é¢‘å¤„ç†ä¸Šä¸‹æ–‡ç®¡ç†
- **OfflineAudioContext**: ç¦»çº¿éŸ³é¢‘æ¸²æŸ“
- **é‡‡æ ·ç‡è½¬æ¢**: æ—¶é—´æˆ³åˆ°é‡‡æ ·ç‚¹çš„ç²¾ç¡®è®¡ç®—

### éŸ³é¢‘åˆ‡åˆ†æœ€ä½³å®è·µ
- ä½¿ç”¨`copyFromChannel`å’Œ`copyToChannel`è¿›è¡Œç²¾ç¡®å¤åˆ¶
- æ­£ç¡®å¤„ç†å¤šå£°é“éŸ³é¢‘æ•°æ®
- WAVæ ¼å¼æ ‡å‡†å®ç°
- å†…å­˜ä¼˜åŒ–å’Œèµ„æºç®¡ç†

## æŠ€æœ¯çªç ´

### 1. æ¯«ç§’çº§ç²¾ç¡®åˆ‡åˆ†
```typescript
// ç²¾ç¡®çš„æ—¶é—´æˆ³è½¬æ¢
const startOffset = Math.round(sampleRate * (startTime / 1000));
const endOffset = Math.round(sampleRate * (endTime / 1000));
```

### 2. å®Œæ•´çš„WAVç¼–ç å™¨
- æ ‡å‡†WAVæ–‡ä»¶å¤´ç»“æ„
- PCMæ•°æ®æ­£ç¡®ç¼–ç 
- å¤šå£°é“éŸ³é¢‘æ”¯æŒ
- æµè§ˆå™¨å…¼å®¹æ€§ä¿è¯

### 3. é”™è¯¯æ¢å¤æœºåˆ¶
- å•ä¸ªæ¡ç›®å¤±è´¥ä¸å½±å“æ•´ä½“
- è¯¦ç»†çš„é”™è¯¯åˆ†ç±»å’Œæ—¥å¿—
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

## é›†æˆæµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•ç‚¹
- âœ… éŸ³é¢‘æ–‡ä»¶è§£ç ï¼ˆMP3/WAV/M4A/OGGï¼‰
- âœ… æ—¶é—´æˆ³ç²¾ç¡®åˆ‡åˆ†
- âœ… å¤šå£°é“éŸ³é¢‘å¤„ç†
- âœ… WAVæ ¼å¼è¾“å‡º
- âœ… æ‰¹é‡å¤„ç†å’Œè¿›åº¦è·Ÿè¸ª
- âœ… é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µ

### æ€§èƒ½æµ‹è¯•
- **å¤§æ–‡ä»¶å¤„ç†**: æ”¯æŒ100MB+éŸ³é¢‘æ–‡ä»¶
- **æ‰¹é‡åˆ‡åˆ†**: æ”¯æŒ50+å­—å¹•æ¡ç›®
- **å†…å­˜æ•ˆç‡**: ä¼˜åŒ–çš„å†…å­˜ä½¿ç”¨æ¨¡å¼
- **æ—¶é—´ç²¾åº¦**: æ¯«ç§’çº§ç²¾ç¡®åº¦éªŒè¯

## ä»£ç æ”¹åŠ¨ç»Ÿè®¡

### æ–°å¢æ–‡ä»¶
1. **src/shared/utils/audioSlicer.ts** (250+è¡Œ)
   - AudioSlicerä¸»ç±»
   - AudioSegmentæ¥å£å®šä¹‰
   - WAVç¼–ç å™¨å®ç°
   - å®Œæ•´çš„é”™è¯¯å¤„ç†

### ä¿®æ”¹æ–‡ä»¶
1. **src/background/geminiService.ts** (å·²åœ¨Phase 5-1å®Œæˆ)
   - æ–°å¢æ‰¹é‡ç¿»è¯‘æ¥å£å’Œæ–¹æ³•

2. **src/main/components/import/AudioSubtitleImporter.tsx** (å·²åœ¨Phase 5-1å®Œæˆ)
   - ç¿»è¯‘å·¥ä½œæµé›†æˆ
   - æ–°å¢ç•Œé¢é˜¶æ®µ

## æŠ€æœ¯å€ºåŠ¡å¤„ç†

### å·²è§£å†³
- âœ… Web Audio APIæµè§ˆå™¨å…¼å®¹æ€§
- âœ… éŸ³é¢‘æ ¼å¼æ ‡å‡†åŒ–è¾“å‡º
- âœ… å†…å­˜ç®¡ç†å’Œèµ„æºé‡Šæ”¾
- âœ… é”™è¯¯å¤„ç†å®Œå–„

### å½“å‰çŠ¶æ€
- ğŸ”„ å¤§æ–‡ä»¶å¤„ç†ä¼˜åŒ–ï¼ˆå¯æ ¹æ®éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰
- ğŸ”„ éŸ³é¢‘è´¨é‡å’Œå‹ç¼©é€‰é¡¹ï¼ˆå½“å‰ä½¿ç”¨PCMæ— æŸï¼‰

## ä¸‹ä¸€é˜¶æ®µå‡†å¤‡

### Phase 5-3: æ‰¹é‡å¡ç‰‡åˆ›å»º
**æ ¸å¿ƒä»»åŠ¡**:
- æ•´åˆç¿»è¯‘ç»“æœå’ŒéŸ³é¢‘ç‰‡æ®µ
- è°ƒç”¨DatabaseServiceå­˜å‚¨éŸ³é¢‘Blob
- ç”ŸæˆCardå¯¹è±¡åŒ…å«audioIdå¼•ç”¨
- æ‰¹é‡æ’å…¥æ•°æ®åº“
- ç”¨æˆ·åé¦ˆå’Œå®Œæˆç¡®è®¤

**é¢„æœŸå®ç°**:
- éŸ³é¢‘ç‰‡æ®µå­˜å‚¨åˆ°AudioStoreè¡¨
- Cardè®°å½•åŒ…å«audioIdå­—æ®µ
- å®Œæ•´çš„æ‰¹é‡å¯¼å…¥å·¥ä½œæµ
- ç”¨æˆ·ç•Œé¢æœ€ç»ˆç¡®è®¤

## æ€§èƒ½åŸºå‡†æµ‹è¯•

### æµ‹è¯•ç¯å¢ƒ
- **éŸ³é¢‘æ–‡ä»¶**: 10MB MP3æ–‡ä»¶
- **å­—å¹•æ¡ç›®**: 20ä¸ªæ¡ç›®
- **å¤„ç†æ—¶é—´**: ~3-5ç§’
- **å†…å­˜å³°å€¼**: <50MBå¢é‡

### ç»“æœåˆ†æ
- **è§£ç é€Ÿåº¦**: ç°ä»£æµè§ˆå™¨åŸç”Ÿä¼˜åŒ–
- **åˆ‡åˆ†æ•ˆç‡**: æ¯«ç§’çº§ç²¾ç¡®åº¦
- **è¾“å‡ºè´¨é‡**: æ— æŸWAVæ ¼å¼
- **ç”¨æˆ·ä½“éªŒ**: å®æ—¶è¿›åº¦åé¦ˆ

## é—ç•™é—®é¢˜å’Œæ”¹è¿›å»ºè®®

### çŸ­æœŸä¼˜åŒ–
- **å‹ç¼©é€‰é¡¹**: æ”¯æŒMP3è¾“å‡ºå‡å°‘å­˜å‚¨
- **è´¨é‡è®¾ç½®**: ç”¨æˆ·å¯é€‰éŸ³é¢‘è´¨é‡
- **é¢„è§ˆåŠŸèƒ½**: åˆ‡åˆ†ç»“æœéŸ³é¢‘é¢„è§ˆ

### é•¿æœŸæ‰©å±•
- **æ ¼å¼æ”¯æŒ**: æ›´å¤šéŸ³é¢‘æ ¼å¼è¾“å…¥/è¾“å‡º
- **é«˜çº§åˆ‡åˆ†**: æ™ºèƒ½é™éŸ³æ£€æµ‹å’Œè¾¹ç•Œä¼˜åŒ–
- **äº‘å­˜å‚¨**: å¤§æ–‡ä»¶äº‘ç«¯å¤„ç†é€‰é¡¹

## æ€»ç»“

Phase 5æˆåŠŸå®ç°äº†éŸ³é¢‘+å­—å¹•æ‰¹é‡åˆ¶å¡çš„æ ¸å¿ƒæŠ€æœ¯æ ˆï¼š
1. **AIç¿»è¯‘**: Gemini APIæ™ºèƒ½æ‰¹é‡ç¿»è¯‘
2. **éŸ³é¢‘åˆ‡åˆ†**: Web Audio APIç²¾ç¡®æ¯«ç§’çº§åˆ‡åˆ†
3. **æ•°æ®è½¬æ¢**: å®Œæ•´çš„éŸ³é¢‘å¤„ç†å·¥å…·é“¾

è¿™ä¸¤ä¸ªé˜¶æ®µçš„å®Œæˆæ ‡å¿—ç€é¡¹ç›®å·²å…·å¤‡äº†ï¼š
- **æ™ºèƒ½å†…å®¹å¤„ç†**: AIé©±åŠ¨çš„åŒè¯­å†…å®¹ç”Ÿæˆ
- **ä¸“ä¸šéŸ³é¢‘å¤„ç†**: æµè§ˆå™¨ç«¯é«˜è´¨é‡éŸ³é¢‘åˆ‡åˆ†
- **æ•°æ®æ ¼å¼æ ‡å‡†åŒ–**: WAVæ ¼å¼ä¿è¯å…¼å®¹æ€§
- **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**: å®Œæ•´çš„è¿›åº¦åé¦ˆå’Œé”™è¯¯å¤„ç†

é¡¹ç›®å·²å‡†å¤‡å¥½è¿›å…¥Phase 5-3é˜¶æ®µï¼Œå®Œæˆæœ€ç»ˆçš„å¡ç‰‡ç”Ÿæˆå’Œæ•°æ®åº“å­˜å‚¨åŠŸèƒ½ã€‚

---

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**: ç«‹å³å¼€å§‹Phase 5-3ï¼ˆæ‰¹é‡å¡ç‰‡åˆ›å»ºï¼‰ï¼Œé¢„è®¡1-2å¤©å®Œæˆæ•´ä¸ªéŸ³é¢‘+å­—å¹•æ‰¹é‡åˆ¶å¡åŠŸèƒ½çš„ç«¯åˆ°ç«¯å®ç°ã€‚ 