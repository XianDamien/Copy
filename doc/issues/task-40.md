[MODE: PLAN]

好的，我已经理解了您的指示。我们将采用“先清理，后优化”的策略。首先，我会修复所有已知的编译错误和代码问题，以确保代码库的健康状态。然后，我将根据您的新思路，实现一个更直观的“手动保存 + 导航时自动保存”的功能，并修复所有相关的测试。

以下是详细的实施计划，我将把这份计划写入一个新的任务文档 `doc/issues/task-40-review-fixes-and-refactor.md`。

---

# **`task-40-review-fixes-and-refactor.md`**

## **Context**

*   **Filename**: `task-40-review-fixes-and-refactor.md`
*   **Created On**: [Current DateTime]
*   **Associated Protocol**: RIPER-5

## **Task Description**

此任务旨在解决复习界面重构（Task 39）后遗留的所有已知问题，包括19个TypeScript编译错误、多个测试失败以及保存逻辑的优化。最终目标是实现一个稳定、无错误且用户体验更佳的复习界面。

## **Project Overview**

本项目是对LanGear插件复习功能的关键修复和体验升级。它将分两个阶段进行：首先是代码库的清理和稳定化，其次是根据用户反馈对笔记保存功能进行核心逻辑重构。

---
*The following sections will be maintained by the AI during protocol execution*
---

## **Analysis (Populated by RESEARCH mode)**

1.  **编译错误 (19个)**：这些错误主要是由于重构后残留的无用导入、废弃函数以及一个明显的属性引用bug (`userTranslation`)。这些问题影响了代码的可维护性，必须优先清理。
2.  **测试失败 (Phase 3)**：测试超时的核心原因是`debounce`逻辑的实现缺陷，以及测试代码中对`fakeTimers`和`waitFor`的不当使用。
3.  **保存逻辑优化**: 用户反馈表明，当前的“全自动保存”逻辑不够直观。新的方向是“**手动保存为主，切换卡片时自动保存为辅**”，这能更好地平衡用户控制和数据安全。

## **Implementation Plan (Generated by PLAN mode)**

此计划将分两个主要阶段执行，确保每一步都有清晰的目标和验证。

### **Phase 1: Code Cleanup & Stabilization**

**目标**: 修复所有已知的19个编译错误，使项目能够成功构建 (`npm run build`)，并为后续的功能修改创建一个干净的基线。

*   **Task 1.1: Fix `CardDisplay.tsx` Bug**
    *   [ ] 打开 `src/main/components/review/CardDisplay.tsx`。
    *   [ ] 移除第66行附近对不存在的属性 `userTranslation` 的引用。

*   **Task 1.2: Clean Up `ReviewControls.tsx`**
    *   [ ] 打开 `src/main/components/review/ReviewControls.tsx`。
    *   [ ] 从 `lucide-react` 的导入语句中，移除所有未使用的图标：`ArrowLeft`, `RotateCcw`, `CheckCircle`, `XCircle`, `Minus`, `Plus`。

*   **Task 1.3: Clean Up `Review.tsx`**
    *   [ ] 打开 `src/main/pages/Review.tsx`。
    *   [ ] 从 `lucide-react` 的导入语句中，移除未使用的图标：`XCircle`, `Minus`, `Plus`, `Edit3`, `SkipForward`, `Send`。
    *   [ ] 删除整个未使用的函数：`shouldShowTaskInterface`, `handleTaskCompletion`, `handleTaskFailure`。

*   **Task 1.4: Clean Up Test Files**
    *   [ ] 移除 `src/tests/review-components-phase1.test.tsx` 中的 `import React from 'react';`。
    *   [ ] 移除 `src/tests/review-inline-editing-phase3.test.tsx` 中的 `import React from 'react';`。
    *   [ ] 移除 `src/tests/review-refactor-phase2.test.tsx` 中的 `import React from 'react';`。

*   **Task 1.5: Validation**
    *   [ ] 在终端运行 `npm run build`，确认不再有任何编译错误。
    *   [ ] 运行 `npm test`，确认测试可以执行（即使有失败），以建立修复基线。

### **Phase 2: Refactor Save Logic & Fix Tests**

**目标**: 实现新的“手动 + 自动”保存逻辑，并修复所有相关的测试用例，确保功能稳定可靠。

*   **Task 2.1: Refactor State in `Review.tsx`**
    *   [ ] 添加两个新的状态：`editedNotes: string | null` 用于暂存用户输入，`isNoteDirty: boolean` 用于标记笔记是否被修改。
    *   [ ] 重写 `handleNoteUpdate`：现在它只负责更新 `editedNotes` 状态和设置 `isNoteDirty` 为 `true`。
    *   [ ] 移除旧的 `debouncedNoteUpdate` 函数和相关的 `useCallback`。

*   **Task 2.2: Implement New Save Handlers in `Review.tsx`**
    *   [ ] 创建一个新的 `async` 函数 `handleSaveChanges()`，它将负责调用 `apiClient.updateNote` 来保存 `editedNotes` 的内容。成功后，它会重置 `isNoteDirty` 和 `editedNotes`。
    *   [ ] 修改 `handleNextCard` 和 `handlePreviousCard`：在切换卡片前，检查 `isNoteDirty`。如果为 `true`，则先调用并等待 `handleSaveChanges()` 完成。

*   **Task 2.3: Update `CardDisplay.tsx` for Manual Save**
    *   [ ] 在 `CardDisplay` 的 `props` 接口中添加 `isDirty: boolean` 和 `onSave: () => void`。
    *   [ ] 将 `RichTextEditor` 的 `value` 绑定到 `editedNotes ?? ctoEFields.notes`，优先显示未保存的更改。
    *   [ ] 在 "学习笔记" 标题旁边添加一个“保存”按钮，其 `disabled` 属性绑定到 `!isDirty`，`onClick` 事件调用 `onSave`。

*   **Task 2.4: Integrate Changes in `Review.tsx`**
    *   [ ] 将 `editedNotes`, `isNoteDirty`, `handleSaveChanges` (作为 `onSave`)，以及新的 `handleNoteUpdate` 作为 props 传递给 `<CardDisplay>` 组件。

*   **Task 2.5: Fix and Update Test Suite**
    *   [ ] 打开 `src/tests/review-inline-editing-phase3.test.tsx`。
    *   [ ] 移除所有对 `vi.useFakeTimers()` 和 `vi.advanceTimersByTime()` 的使用。
    *   [ ] **重写测试用例**以匹配新逻辑：
        *   **测试1 (UI State)**: 验证编辑后，“保存”按钮从 `disabled` 变为可用。
        *   **测试2 (Manual Save)**: 验证点击“保存”按钮会调用 `updateNote` API，并且成功后按钮再次变为 `disabled`。
        *   **测试3 (Auto-save on Navigation)**: 验证在笔记被修改后点击“下一个”按钮，会先调用 `updateNote` API。
        *   **测试4 (Error Handling)**: 验证当保存失败时，会显示错误提示。

---

我将严格按照此计划顺序执行。首先是清理，然后是功能重构。