# 任务58: 音频与字幕对齐的批量导入功能

**文档版本**: 2025年7月11日  
**执行者**: Claude Sonnet 4  
**优先级**: 高  
**预计开发时间**: 14-18天

## 总体目标

在现有的批量导入页面 (`BulkImportPage.tsx`) 中新增一种"音频/字幕"导入模式，允许用户上传音频和字幕文件，通过可视化界面将字幕与音频片段对齐，并最终批量生成带音频的学习卡片。

## 技术架构

### 核心技术栈
- **音频可视化**: wavesurfer.js + Regions plugin
- **字幕解析**: @plussub/srt-vtt-parser
- **音频处理**: Web Audio API
- **数据存储**: 现有 IndexedDB AudioStore 表
- **AI翻译**: 现有 Gemini API 服务

### 数据流程
1. 用户上传音频文件和字幕文件
2. 解析字幕文件获得时间戳和文本
3. 在音频波形上自动创建对应区域
4. 用户可视化调整音频切分点
5. AI批量翻译字幕文本
6. 切分音频并存储为Blob
7. 批量创建音频卡片

## Phase 1: 后端与数据结构准备 (2-3天)

### 任务 1.1: 更新共享类型定义
**目标**: 为Card接口添加audioId字段

**实现步骤**:
1. 修改 `src/shared/types/index.ts` 中的Card接口
2. 添加可选的 `audioId?: string` 字段
3. 确保类型兼容性

### 任务 1.2: 扩展数据库服务
**目标**: 添加音频存储和检索方法

**实现步骤**:
1. 在 `DatabaseService` 中添加 `addAudioClip` 方法
2. 添加 `getAudioClip` 方法
3. 修改卡片创建逻辑支持audioId
4. 编写单元测试验证数据库操作

## Phase 2: UI基础与文件处理 (2-3天)

### 任务 2.1: 修改批量导入页面
**目标**: 添加音频/字幕导入模式

**实现步骤**:
1. 在 `BulkImportPage.tsx` 添加模式切换器
2. 实现条件渲染逻辑
3. 保持现有功能完整性

### 任务 2.2: 创建音频字幕导入器组件
**目标**: 实现文件上传和验证

**实现步骤**:
1. 创建 `AudioSubtitleImporter.tsx` 组件
2. 实现双文件上传区域
3. 添加文件类型和大小验证
4. 实现上传进度显示

## Phase 3: 字幕解析与同步逻辑 (2-3天)

### 任务 3.1: 集成字幕解析库
**目标**: 安装和配置依赖

**实现步骤**:
1. 使用npm安装 `wavesurfer.js` 和 `@plussub/srt-vtt-parser`
2. 配置TypeScript类型定义
3. 验证库兼容性

### 任务 3.2: 实现字幕解析服务
**目标**: 标准化字幕数据格式

**实现步骤**:
1. 创建 `subtitleParser.ts` 工具函数
2. 支持SRT和VTT格式解析
3. 统一时间戳格式(毫秒)
4. 编写解析测试用例

### 任务 3.3: 字幕列表UI组件
**目标**: 显示和交互字幕数据

**实现步骤**:
1. 设计字幕列表界面
2. 实现点击跳转功能
3. 添加选择和编辑功能

## Phase 4: 音频可视化与切分界面 (3-4天)

### 任务 4.1: 音频可视化组件
**目标**: 集成wavesurfer.js显示音频波形

**实现步骤**:
1. 创建 `AudioVisualizer.tsx` 组件
2. 配置wavesurfer.js基础设置
3. 集成Regions插件
4. 实现音频加载和播放控制

### 任务 4.2: 字幕音频自动关联
**目标**: 基于时间戳自动创建音频区域

**实现步骤**:
1. 遍历字幕数据创建regions
2. 实现点击字幕跳转到对应音频位置
3. 添加区域高亮显示
4. 同步字幕列表和音频区域状态

### 任务 4.3: 音频区域手动编辑
**目标**: 支持拖拽调整音频切分点

**实现步骤**:
1. 启用regions拖拽功能
2. 实时更新区域边界
3. 同步更新字幕时间戳
4. 添加精确时间输入框

## Phase 5: AI翻译与卡片生成 (3-4天)

### 任务 5.1: 批量翻译实现
**目标**: 集成Gemini API进行批量翻译

**实现步骤**:
1. 收集所有字幕文本
2. 分批调用翻译API避免限制
3. 实现翻译进度显示
4. 添加翻译结果编辑功能

### 任务 5.2: 音频切分与存储
**目标**: 使用Web Audio API切分音频

**实现步骤**:
1. 创建 `audioUtils.ts` 工具函数
2. 实现音频buffer切分逻辑
3. 转换为Blob格式存储
4. 优化大文件处理性能

### 任务 5.3: 卡片批量创建
**目标**: 生成最终的学习卡片

**实现步骤**:
1. 组合原文、译文和audioId
2. 批量创建Note和Card对象
3. 事务性存储到数据库
4. 显示创建结果统计

## Phase 6: 复习集成与测试 (2-3天)

### 任务 6.1: 复习页面音频支持
**目标**: 在复习界面支持音频播放

**实现步骤**:
1. 修改 `Review.tsx` 检测audioId
2. 创建 `AudioPlayer.tsx` 组件
3. 实现音频播放和控制
4. 添加播放状态指示

### 任务 6.2: 端到端测试
**目标**: 验证完整工作流程

**实现步骤**:
1. 创建集成测试用例
2. 模拟完整导入流程
3. 验证数据库存储正确性
4. 测试复习界面音频播放

## 质量保证

### 测试策略
- **单元测试**: 每个工具函数和服务方法
- **组件测试**: UI组件交互和状态管理
- **集成测试**: 完整的数据流程
- **性能测试**: 大文件处理能力

### 错误处理
- 文件格式验证和错误提示
- 网络请求失败重试机制
- 音频处理异常处理
- 数据库操作错误恢复

## 成功指标

### 功能指标
- [ ] 支持MP3, WAV, M4A音频格式
- [ ] 支持SRT, VTT字幕格式
- [ ] 音频文件最大支持100MB
- [ ] 翻译准确率>85%
- [ ] 处理速度<30秒(100MB文件)

### 用户体验指标
- [ ] 文件上传成功率>99%
- [ ] 操作响应时间<200ms
- [ ] 错误恢复成功率>90%
- [ ] 界面操作直观易用

---

**创建时间**: 2025年7月11日  
**最后更新**: 2025年7月11日  
**状态**: 准备开始执行 