import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect, vi, beforeEach } from 'vitest';
import TaskDisplay from '../main/components/review/TaskDisplay';
import TaskControls from '../main/components/review/TaskControls';

describe('Task Mode Integration Tests', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('Mode Indicator Integration', () => {
    it('should work with task display and controls together', () => {
      const mockProps = {
        onSubmit: vi.fn(),
        onSkip: vi.fn(),
        onEditCard: vi.fn(),
        onPreviousCard: vi.fn(),
        onNextCard: vi.fn(),
        canGoPrevious: true,
        canGoNext: true,
        currentCardIndex: 0,
        totalCards: 5
      };

      render(
        <div>
          {/* æ¨¡æ‹Ÿä»»åŠ¡æ¨¡å¼ç•Œé¢å¸ƒå±€ */}
          <div className="flex justify-center mb-4">
            <div className="bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-medium">
              ä»»åŠ¡æ¨¡å¼ - æ–°å¡ç‰‡å­¦ä¹?
            </div>
          </div>
          <TaskDisplay originalText="<p>æµ‹è¯•HTMLå†…å®¹</p>" />
          <TaskControls {...mockProps} />
        </div>
      );

      // éªŒè¯æ¨¡å¼æŒ‡ç¤ºå™?
      expect(screen.getByText('ä»»åŠ¡æ¨¡å¼ - æ–°å¡ç‰‡å­¦ä¹?)).toBeInTheDocument();
      
      // éªŒè¯HTMLæ¸²æŸ“
      expect(screen.getByText('æµ‹è¯•HTMLå†…å®¹')).toBeInTheDocument();
      expect(screen.queryByText('<p>')).not.toBeInTheDocument();
      
      // éªŒè¯æ§åˆ¶æŒ‰é’®
      expect(screen.getByText('æäº¤ç¿»è¯‘')).toBeInTheDocument();
      expect(screen.getByText('æ— æ³•å®Œæˆ')).toBeInTheDocument();
      expect(screen.getByTitle('ç¼–è¾‘å¡ç‰‡ (E)')).toBeInTheDocument();
      expect(screen.getByText('ä¸Šä¸€ä¸?)).toBeInTheDocument();
      expect(screen.getByText('ä¸‹ä¸€ä¸?)).toBeInTheDocument();
      
      // éªŒè¯è¿›åº¦æŒ‡ç¤º
      expect(screen.getByText('1 / 5')).toBeInTheDocument();
    });
  });

  describe('HTML Rendering in Task Mode', () => {
    it('should render complex HTML structures correctly', () => {
      const complexHtml = '<strong>é‡è¦æç¤ºï¼?/strong><br/><em>è¿™æ˜¯ä¸€ä¸?/em><u>æµ‹è¯•å†…å®¹</u>';
      
      render(<TaskDisplay originalText={complexHtml} />);
      
      // éªŒè¯æ–‡æœ¬å†…å®¹è¢«æ­£ç¡®æå–å’Œæ˜¾ç¤º
      expect(screen.getByText('é‡è¦æç¤ºï¼?)).toBeInTheDocument();
      expect(screen.getByText('è¿™æ˜¯ä¸€ä¸?)).toBeInTheDocument();
      expect(screen.getByText('æµ‹è¯•å†…å®¹')).toBeInTheDocument();
      
      // ç¡®ä¿HTMLæ ‡ç­¾ä¸ä¼šæ˜¾ç¤ºä¸ºæ–‡æœ?
      expect(screen.queryByText('<strong>')).not.toBeInTheDocument();
      expect(screen.queryByText('<br/>')).not.toBeInTheDocument();
      expect(screen.queryByText('<em>')).not.toBeInTheDocument();
      expect(screen.queryByText('<u>')).not.toBeInTheDocument();
    });

    it('should handle mixed Chinese and HTML content', () => {
      const mixedContent = 'æˆ‘çš„åº§ä½<p>å¾ˆå¥½</p>ï¼?strong>éå¸¸</strong>èˆ’é€‚ã€?;
      
      render(<TaskDisplay originalText={mixedContent} />);
      
      // ä½¿ç”¨ container.textContent æ£€æŸ¥æ•´ä½“æ–‡æœ¬å†…å®?
      expect(container.textContent).toContain('æˆ‘çš„åº§ä½');
      expect(container.textContent).toContain('å¾ˆå¥½');
      expect(container.textContent).toContain('éå¸¸');
      expect(container.textContent).toContain('èˆ’é€?);
      
      // éªŒè¯HTMLç»“æ„è¢«æ­£ç¡®æ¸²æŸ?
      const contentDiv = container.querySelector('.text-primary-900');
      expect(contentDiv).toBeInTheDocument();
    });
  });

  describe('Enhanced Task Controls', () => {
    it('should integrate all control functions properly', () => {
      const mockFunctions = {
        onSubmit: vi.fn(),
        onSkip: vi.fn(),
        onEditCard: vi.fn(),
        onPreviousCard: vi.fn(),
        onNextCard: vi.fn()
      };

      render(
        <TaskControls 
          {...mockFunctions}
          canGoPrevious={true}
          canGoNext={true}
          currentCardIndex={2}
          totalCards={10}
        />
      );

      // æµ‹è¯•ä¸»è¦åŠŸèƒ½æŒ‰é’®
      fireEvent.click(screen.getByText('æäº¤ç¿»è¯‘'));
      expect(mockFunctions.onSubmit).toHaveBeenCalledTimes(1);

      fireEvent.click(screen.getByText('æ— æ³•å®Œæˆ'));
      expect(mockFunctions.onSkip).toHaveBeenCalledTimes(1);

      // æµ‹è¯•ç¼–è¾‘åŠŸèƒ½
      fireEvent.click(screen.getByTitle('ç¼–è¾‘å¡ç‰‡ (E)'));
      expect(mockFunctions.onEditCard).toHaveBeenCalledTimes(1);

      // æµ‹è¯•å¯¼èˆªåŠŸèƒ½
      fireEvent.click(screen.getByText('ä¸Šä¸€ä¸?));
      expect(mockFunctions.onPreviousCard).toHaveBeenCalledTimes(1);

      fireEvent.click(screen.getByText('ä¸‹ä¸€ä¸?));
      expect(mockFunctions.onNextCard).toHaveBeenCalledTimes(1);

      // éªŒè¯è¿›åº¦æ˜¾ç¤º
      expect(screen.getByText('3 / 10')).toBeInTheDocument();
    });

    it('should handle boundary conditions correctly', () => {
      const mockFunctions = {
        onSubmit: vi.fn(),
        onSkip: vi.fn(),
        onEditCard: vi.fn(),
        onPreviousCard: vi.fn(),
        onNextCard: vi.fn()
      };

      // æµ‹è¯•ç¬¬ä¸€å¼ å¡ç‰‡ï¼ˆä¸èƒ½ä¸Šä¸€ä¸ªï¼‰
      const { rerender } = render(
        <TaskControls 
          {...mockFunctions}
          canGoPrevious={false}
          canGoNext={true}
          currentCardIndex={0}
          totalCards={5}
        />
      );

      const previousButton = screen.getByText('ä¸Šä¸€ä¸?);
      const nextButton = screen.getByText('ä¸‹ä¸€ä¸?);

      expect(previousButton).toBeDisabled();
      expect(nextButton).not.toBeDisabled();
      expect(screen.getByText('1 / 5')).toBeInTheDocument();

      // æµ‹è¯•æœ€åä¸€å¼ å¡ç‰‡ï¼ˆä¸èƒ½ä¸‹ä¸€ä¸ªï¼‰
      rerender(
        <TaskControls 
          {...mockFunctions}
          canGoPrevious={true}
          canGoNext={false}
          currentCardIndex={4}
          totalCards={5}
        />
      );

      expect(screen.getByText('ä¸Šä¸€ä¸?)).not.toBeDisabled();
      expect(screen.getByText('ä¸‹ä¸€ä¸?)).toBeDisabled();
      expect(screen.getByText('5 / 5')).toBeInTheDocument();
    });
  });

  describe('Complete Task Mode Workflow', () => {
    it('should simulate a complete task mode interaction', () => {
      const mockFunctions = {
        onSubmit: vi.fn(),
        onSkip: vi.fn(),
        onEditCard: vi.fn(),
        onPreviousCard: vi.fn(),
        onNextCard: vi.fn()
      };

      render(
        <div className="max-w-4xl mx-auto p-6 space-y-6">
          {/* æ¨¡å¼æŒ‡ç¤ºå™?*/}
          <div className="flex justify-center mb-4">
            <div className="bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-medium">
              ä»»åŠ¡æ¨¡å¼ - æ–°å¡ç‰‡å­¦ä¹?
            </div>
          </div>
          
          {/* ä»»åŠ¡æ˜¾ç¤º */}
          <TaskDisplay originalText="<p>æˆ‘éœ€è¦ç¿»è¯‘è¿™ä¸ªå¥å­?/p>" />
          
          {/* æ¨¡æ‹Ÿç¿»è¯‘è¾“å…¥ */}
          <div className="bg-white rounded-lg shadow-sm border border-primary-200 p-4">
            <textarea 
              placeholder="è¯·è¾“å…¥æ‚¨çš„ç¿»è¯?.."
              className="w-full h-32 p-3 border border-primary-300 rounded-md"
              data-testid="translation-input"
            />
          </div>
          
          {/* ä»»åŠ¡æ§åˆ¶ */}
          <TaskControls 
            {...mockFunctions}
            canGoPrevious={true}
            canGoNext={true}
            currentCardIndex={1}
            totalCards={3}
          />
        </div>
      );

      // éªŒè¯å®Œæ•´ç•Œé¢å­˜åœ¨
      expect(screen.getByText('ä»»åŠ¡æ¨¡å¼ - æ–°å¡ç‰‡å­¦ä¹?)).toBeInTheDocument();
      expect(screen.getByText('æˆ‘éœ€è¦ç¿»è¯‘è¿™ä¸ªå¥å­?)).toBeInTheDocument();
      expect(screen.getByText('è¯·ç¿»è¯‘ä»¥ä¸‹å†…å®¹ï¼š')).toBeInTheDocument();
      expect(screen.getByTestId('translation-input')).toBeInTheDocument();
      
      // æ¨¡æ‹Ÿç”¨æˆ·äº¤äº’æµç¨‹
      const translationInput = screen.getByTestId('translation-input');
      fireEvent.change(translationInput, { target: { value: 'I need to translate this sentence' } });
      
      // ç”¨æˆ·å¯ä»¥ç¼–è¾‘å¡ç‰‡
      fireEvent.click(screen.getByTitle('ç¼–è¾‘å¡ç‰‡ (E)'));
      expect(mockFunctions.onEditCard).toHaveBeenCalled();
      
      // ç”¨æˆ·å¯ä»¥å¯¼èˆª
      fireEvent.click(screen.getByText('ä¸Šä¸€ä¸?));
      expect(mockFunctions.onPreviousCard).toHaveBeenCalled();
      
      // ç”¨æˆ·å¯ä»¥æäº¤ç¿»è¯‘
      fireEvent.click(screen.getByText('æäº¤ç¿»è¯‘'));
      expect(mockFunctions.onSubmit).toHaveBeenCalled();
      
      // éªŒè¯æ‰€æœ‰åŠŸèƒ½éƒ½è¢«æ­£ç¡®è°ƒç”?
      expect(mockFunctions.onEditCard).toHaveBeenCalledTimes(1);
      expect(mockFunctions.onPreviousCard).toHaveBeenCalledTimes(1);
      expect(mockFunctions.onSubmit).toHaveBeenCalledTimes(1);
    });
  });
}); 
