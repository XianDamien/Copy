import{a as ye,g as me,b as be}from"../../settingsService-BBzcUuZY.js";import{c as z,a as _e,g as De}from"../../_commonjsHelpers-BosuxZz1.js";const Y=(n,e)=>e.some(t=>n instanceof t);let ce,de;function Ie(){return ce||(ce=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Se(){return de||(de=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Z=new WeakMap,H=new WeakMap,U=new WeakMap;function Ae(n){const e=new Promise((t,a)=>{const s=()=>{n.removeEventListener("success",i),n.removeEventListener("error",l)},i=()=>{t(F(n.result)),s()},l=()=>{a(n.error),s()};n.addEventListener("success",i),n.addEventListener("error",l)});return U.set(e,n),e}function Ee(n){if(Z.has(n))return;const e=new Promise((t,a)=>{const s=()=>{n.removeEventListener("complete",i),n.removeEventListener("error",l),n.removeEventListener("abort",l)},i=()=>{t(),s()},l=()=>{a(n.error||new DOMException("AbortError","AbortError")),s()};n.addEventListener("complete",i),n.addEventListener("error",l),n.addEventListener("abort",l)});Z.set(n,e)}let Q={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return Z.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return F(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function ge(n){Q=n(Q)}function Ce(n){return Se().includes(n)?function(...e){return n.apply(J(this),e),F(this.request)}:function(...e){return F(n.apply(J(this),e))}}function ke(n){return typeof n=="function"?Ce(n):(n instanceof IDBTransaction&&Ee(n),Y(n,Ie())?new Proxy(n,Q):n)}function F(n){if(n instanceof IDBRequest)return Ae(n);if(H.has(n))return H.get(n);const e=ke(n);return e!==n&&(H.set(n,e),U.set(e,n)),e}const J=n=>U.get(n);function Re(n,e,{blocked:t,upgrade:a,blocking:s,terminated:i}={}){const l=indexedDB.open(n,e),c=F(l);return a&&l.addEventListener("upgradeneeded",r=>{a(F(l.result),r.oldVersion,r.newVersion,F(l.transaction),r)}),t&&l.addEventListener("blocked",r=>t(r.oldVersion,r.newVersion,r)),c.then(r=>{i&&r.addEventListener("close",()=>i()),s&&r.addEventListener("versionchange",o=>s(o.oldVersion,o.newVersion,o))}).catch(()=>{}),c}const Te=["get","getKey","getAll","getAllKeys","count"],Ne=["put","add","delete","clear"],V=new Map;function ue(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(V.get(e))return V.get(e);const t=e.replace(/FromIndex$/,""),a=e!==t,s=Ne.includes(t);if(!(t in(a?IDBIndex:IDBObjectStore).prototype)||!(s||Te.includes(t)))return;const i=async function(l,...c){const r=this.transaction(l,s?"readwrite":"readonly");let o=r.store;return a&&(o=o.index(c.shift())),(await Promise.all([o[t](...c),s&&r.done]))[0]};return V.set(e,i),i}ge(n=>({...n,get:(e,t,a)=>ue(e,t)||n.get(e,t,a),has:(e,t)=>!!ue(e,t)||n.has(e,t)}));const Le=["continue","continuePrimaryKey","advance"],le={},ee=new WeakMap,pe=new WeakMap,Me={get(n,e){if(!Le.includes(e))return n[e];let t=le[e];return t||(t=le[e]=function(...a){ee.set(this,pe.get(this)[e](...a))}),t}};async function*Be(...n){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...n)),!e)return;e=e;const t=new Proxy(e,Me);for(pe.set(t,e),U.set(t,J(e));e;)yield t,e=await(ee.get(t)||e.continue()),ee.delete(t)}function fe(n,e){return e===Symbol.asyncIterator&&Y(n,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&Y(n,[IDBIndex,IDBObjectStore])}ge(n=>({...n,get(e,t,a){return fe(e,t)?Be:n.get(e,t,a)},has(e,t){return fe(e,t)||n.has(e,t)}}));const Fe="LanGearDB",ze=2;class $e{constructor(){this.db=null}async initDatabase(){try{this.db=await Re(Fe,ze,{upgrade(e,t,a,s){if(console.log(`Upgrading database from version ${t} to ${a}`),e.objectStoreNames.contains("decks")||e.createObjectStore("decks",{keyPath:"id",autoIncrement:!0}).createIndex("name","name",{unique:!1}),!e.objectStoreNames.contains("notes")){const i=e.createObjectStore("notes",{keyPath:"id",autoIncrement:!0});i.createIndex("deckId","deckId",{unique:!1}),i.createIndex("noteType","noteType",{unique:!1}),i.createIndex("tags","tags",{unique:!1,multiEntry:!0})}if(e.objectStoreNames.contains("cards")){if(t<2){const i=s.objectStore("cards");i.indexNames.contains("deckId")||i.createIndex("deckId","deckId",{unique:!1}),i.indexNames.contains("deckId-due")||i.createIndex("deckId-due",["deckId","due"],{unique:!1})}}else{const i=e.createObjectStore("cards",{keyPath:"id",autoIncrement:!0});i.createIndex("noteId","noteId",{unique:!1}),i.createIndex("deckId","deckId",{unique:!1}),i.createIndex("due","due",{unique:!1}),i.createIndex("state","state",{unique:!1}),i.createIndex("deckId-due",["deckId","due"],{unique:!1})}if(!e.objectStoreNames.contains("reviewLogs")){const i=e.createObjectStore("reviewLogs",{keyPath:"id",autoIncrement:!0});i.createIndex("cardId","cardId",{unique:!1}),i.createIndex("reviewTime","reviewTime",{unique:!1})}e.objectStoreNames.contains("audioStore")||e.createObjectStore("audioStore",{keyPath:"id"}).createIndex("createdAt","createdAt",{unique:!1})}}),console.log("Database initialized successfully")}catch(e){throw console.error("Failed to initialize database:",e),e}}ensureDatabase(){if(!this.db)throw new Error("Database not initialized. Call initDatabase() first.");return this.db}async createDeck(e){const t=this.ensureDatabase(),a=new Date,s={...e,fsrsConfig:{...ye,...e.fsrsConfig},createdAt:a,updatedAt:a},i=await t.add("decks",s);return{...s,id:i}}async getAllDecks(){return(await this.ensureDatabase().getAll("decks")).map(a=>({...a,createdAt:typeof a.createdAt=="string"?new Date(a.createdAt):a.createdAt,updatedAt:typeof a.updatedAt=="string"?new Date(a.updatedAt):a.updatedAt}))}async getDeckById(e){const a=await this.ensureDatabase().get("decks",e);return a?{...a,createdAt:typeof a.createdAt=="string"?new Date(a.createdAt):a.createdAt,updatedAt:typeof a.updatedAt=="string"?new Date(a.updatedAt):a.updatedAt}:void 0}async updateDeck(e,t){const a=this.ensureDatabase(),s=await a.get("decks",e);if(!s)throw new Error(`Deck with id ${e} not found`);const i={...s,...t,updatedAt:new Date};return await a.put("decks",i),i}async deleteDeck(e){const a=this.ensureDatabase().transaction(["decks","notes","cards","reviewLogs"],"readwrite");if(!await a.objectStore("decks").get(e))throw new Error(`Deck with id ${e} not found`);const l=(await a.objectStore("notes").index("deckId").getAll(e)).map(c=>c.id);for(const c of l){const r=await a.objectStore("cards").index("noteId").getAll(c),o=r.map(u=>u.id);for(const u of o){const d=await a.objectStore("reviewLogs").index("cardId").getAll(u);for(const f of d)await a.objectStore("reviewLogs").delete(f.id)}for(const u of r)await a.objectStore("cards").delete(u.id);await a.objectStore("notes").delete(c)}await a.objectStore("decks").delete(e),await a.done}async createNote(e){const t=this.ensureDatabase(),a=new Date;try{const{id:s,createdAt:i,updatedAt:l,...c}=e,r={...c,createdAt:a,updatedAt:a};console.log("Creating note with clean data:",{...r,id:"[auto-generated]"});const o=await t.add("notes",r),u={...r,id:o};return console.log("Note created successfully with ID:",o),u}catch(s){throw console.error("Failed to create note:",s),s instanceof Error&&s.name==="ConstraintError"?new Error("Note creation failed: Duplicate key conflict. This may indicate database corruption or concurrent operations."):s}}async getNotesByDeckId(e){return(await this.ensureDatabase().getAllFromIndex("notes","deckId",e)).map(s=>this.convertDatesInNote(s))}async getNoteById(e){const a=await this.ensureDatabase().get("notes",e);return a?this.convertDatesInNote(a):void 0}async updateNote(e,t){const a=this.ensureDatabase(),s=await a.get("notes",e);if(!s)throw new Error(`Note with id ${e} not found`);const i={...s,...t,updatedAt:new Date};return await a.put("notes",i),i}async deleteNote(e){const a=(await this.ensureDatabase()).transaction(["notes","cards","reviewLogs"],"readwrite"),s=await a.objectStore("cards").index("noteId").getAll(e);for(const i of s){const l=await a.objectStore("reviewLogs").index("cardId").getAll(i.id);for(const c of l)await a.objectStore("reviewLogs").delete(c.id);await a.objectStore("cards").delete(i.id)}await a.objectStore("notes").delete(e),await a.done}async createCardsForNote(e){const t=this.ensureDatabase(),a=[],s=new Date;switch(console.log("Creating cards for note:",e.id,"type:",e.noteType),e.noteType){case"CtoE":a.push({noteId:e.id,deckId:e.deckId,cardType:"CtoE",state:"New",due:s,stability:0,difficulty:0,elapsedDays:0,scheduledDays:0,reps:0,lapses:0,createdAt:s,updatedAt:s});break;case"Retranslate":a.push({noteId:e.id,deckId:e.deckId,cardType:"Retranslate",state:"New",due:s,stability:0,difficulty:0,elapsedDays:0,scheduledDays:0,reps:0,lapses:0,createdAt:s,updatedAt:s});break;default:throw new Error(`Unsupported note type: ${e.noteType}`)}try{const i=[];for(const l of a){console.log("Adding card to database:",{...l,id:"[auto-generated]"});const c=await t.add("cards",l),r={...l,id:c};i.push(r),console.log("Card created successfully with ID:",c)}return console.log("All cards created successfully for note:",e.id,"total cards:",i.length),i}catch(i){throw console.error("Failed to create cards for note:",e.id,i),i instanceof Error&&i.name==="ConstraintError"?new Error(`Card creation failed for note ${e.id}: Auto-increment key conflict. This may indicate database corruption.`):i}}async getDueCards(e,t,a,s){const i=this.ensureDatabase(),l=new Date;let c;if(e){const u=i.transaction("cards","readonly").store.index("deckId-due"),d=IDBKeyRange.bound([e,new Date(0)],[e,l]);c=await u.getAll(d)}else c=await i.getAll("cards");const r=c.map(o=>this.convertDatesInCard(o)).filter(o=>o.due<=l);return r.sort((o,u)=>o.due.getTime()-u.due.getTime()),a!==void 0||s!==void 0?this.applyDailyLimits(r,a,s):t?r.slice(0,t):r}async applyDailyLimits(e,t,a){const s=await this.getTodayReviewCounts(),i=[];let l=0,c=0;for(const r of e){const o=r.state==="New",u=r.state==="Review"||r.state==="Learning"||r.state==="Relearning";if(o&&t!==void 0){if(s.newCards+l>=t)continue;l++}if(u&&a!==void 0){if(s.reviewCards+c>=a)continue;c++}i.push(r)}return i}async getTodayReviewCounts(){const e=this.ensureDatabase(),t=new Date,a=new Date(t.getFullYear(),t.getMonth(),t.getDate()),s=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1),l=e.transaction("reviewLogs","readonly").store.index("reviewTime"),c=IDBKeyRange.bound(a,s,!1,!0),r=await l.getAll(c);let o=0,u=0;for(const d of r)d.stateBefore==="New"?o++:u++;return{newCards:o,reviewCards:u}}async getCardsByDeckId(e){return(await this.ensureDatabase().getAllFromIndex("cards","deckId",e)).map(s=>this.convertDatesInCard(s))}async getCardById(e){const a=await this.ensureDatabase().get("cards",e);return a?this.convertDatesInCard(a):void 0}async updateCard(e,t){const a=this.ensureDatabase(),s=await this.getCardById(e);if(!s)throw new Error(`Card with id ${e} not found`);const i={...s,...t,updatedAt:new Date};return await a.put("cards",i),i}async resetCardProgress(e){const t=this.ensureDatabase(),a=await this.getCardById(e);if(!a)throw new Error(`Card with id ${e} not found`);const s={...a,state:"New",due:new Date,stability:0,difficulty:0,elapsedDays:0,scheduledDays:0,reps:0,lapses:0,lastReview:void 0,updatedAt:new Date};await t.put("cards",s);const i=t.transaction(["reviewLogs"],"readwrite"),c=i.objectStore("reviewLogs").index("cardId");for await(const r of c.iterate(e))await r.delete();await i.done}async addReviewLog(e){const a=await this.ensureDatabase().add("reviewLogs",e);return{...e,id:a}}async getReviewLogsByCardId(e){return(await this.ensureDatabase().getAllFromIndex("reviewLogs","cardId",e)).map(s=>this.convertDatesInReviewLog(s))}async getDeckStatistics(e){const t=this.ensureDatabase(),a=await t.getAllFromIndex("notes","deckId",e),s=await t.getAllFromIndex("cards","deckId",e),i=a.map(w=>this.convertDatesInNote(w)),l=s.map(w=>this.convertDatesInCard(w)),c=i.length;let r=l.length,o=0,u=0,d=0,f=0;const h=new Date;for(const w of l){switch(w.state){case"New":o++;break;case"Learning":u++;break;case"Review":d++;break}w.due<=h&&f++}return{totalCards:r,newCards:o,learningCards:u,reviewCards:d,dueCards:f,totalNotes:c}}convertDatesInCard(e){return{...e,due:typeof e.due=="string"?new Date(e.due):e.due,createdAt:typeof e.createdAt=="string"?new Date(e.createdAt):e.createdAt,updatedAt:typeof e.updatedAt=="string"?new Date(e.updatedAt):e.updatedAt}}convertDatesInNote(e){return{...e,createdAt:typeof e.createdAt=="string"?new Date(e.createdAt):e.createdAt,updatedAt:typeof e.updatedAt=="string"?new Date(e.updatedAt):e.updatedAt}}convertDatesInReviewLog(e){return{...e,reviewTime:typeof e.reviewTime=="string"?new Date(e.reviewTime):e.reviewTime}}async validateDatabaseIntegrity(){const e=this.ensureDatabase(),t=[];let a=0;try{const s=await e.getAll("cards"),i=await e.getAll("notes"),l=new Set(i.map(w=>w.id)),c=s.filter(w=>!l.has(w.noteId));c.length>0&&(t.push(`Found ${c.length} orphaned cards without corresponding notes`),a+=c.length);const r=await e.getAll("reviewLogs"),o=new Set(s.map(w=>w.id)),u=r.filter(w=>!o.has(w.cardId));u.length>0&&(t.push(`Found ${u.length} orphaned review logs without corresponding cards`),a+=u.length);const d=await e.getAll("decks"),f=new Set(d.map(w=>w.id)),h=i.filter(w=>!f.has(w.deckId));return h.length>0&&(t.push(`Found ${h.length} orphaned notes without corresponding decks`),a+=h.length),console.log("Database integrity check completed:",{isValid:t.length===0,issues:t,orphanedRecords:a}),{isValid:t.length===0,issues:t,orphanedRecords:a}}catch(s){return console.error("Database integrity validation failed:",s),{isValid:!1,issues:[`Validation failed: ${s instanceof Error?s.message:"Unknown error"}`],orphanedRecords:0}}}async clearAllData(){const t=this.ensureDatabase().transaction(["decks","notes","cards","reviewLogs","audioStore"],"readwrite");await t.objectStore("reviewLogs").clear(),await t.objectStore("cards").clear(),await t.objectStore("notes").clear(),await t.objectStore("decks").clear(),await t.objectStore("audioStore").clear(),await t.done}close(){this.db&&(this.db.close(),this.db=null)}}const x=new $e;var ae={exports:{}};ae.exports;(function(n){(function(e,t,a){function s(r){var o=this,u=c();o.next=function(){var d=2091639*o.s0+o.c*23283064365386963e-26;return o.s0=o.s1,o.s1=o.s2,o.s2=d-(o.c=d|0)},o.c=1,o.s0=u(" "),o.s1=u(" "),o.s2=u(" "),o.s0-=u(r),o.s0<0&&(o.s0+=1),o.s1-=u(r),o.s1<0&&(o.s1+=1),o.s2-=u(r),o.s2<0&&(o.s2+=1),u=null}function i(r,o){return o.c=r.c,o.s0=r.s0,o.s1=r.s1,o.s2=r.s2,o}function l(r,o){var u=new s(r),d=o&&o.state,f=u.next;return f.int32=function(){return u.next()*4294967296|0},f.double=function(){return f()+(f()*2097152|0)*11102230246251565e-32},f.quick=f,d&&(typeof d=="object"&&i(d,u),f.state=function(){return i(u,{})}),f}function c(){var r=4022871197,o=function(u){u=String(u);for(var d=0;d<u.length;d++){r+=u.charCodeAt(d);var f=.02519603282416938*r;r=f>>>0,f-=r,f*=r,r=f>>>0,f-=r,r+=f*4294967296}return(r>>>0)*23283064365386963e-26};return o}t&&t.exports?t.exports=l:this.alea=l})(z,n)})(ae);var je=ae.exports,re={exports:{}};re.exports;(function(n){(function(e,t,a){function s(c){var r=this,o="";r.x=0,r.y=0,r.z=0,r.w=0,r.next=function(){var d=r.x^r.x<<11;return r.x=r.y,r.y=r.z,r.z=r.w,r.w^=r.w>>>19^d^d>>>8},c===(c|0)?r.x=c:o+=c;for(var u=0;u<o.length+64;u++)r.x^=o.charCodeAt(u)|0,r.next()}function i(c,r){return r.x=c.x,r.y=c.y,r.z=c.z,r.w=c.w,r}function l(c,r){var o=new s(c),u=r&&r.state,d=function(){return(o.next()>>>0)/4294967296};return d.double=function(){do var f=o.next()>>>11,h=(o.next()>>>0)/4294967296,w=(f+h)/(1<<21);while(w===0);return w},d.int32=o.next,d.quick=d,u&&(typeof u=="object"&&i(u,o),d.state=function(){return i(o,{})}),d}t&&t.exports?t.exports=l:this.xor128=l})(z,n)})(re);var Pe=re.exports,ne={exports:{}};ne.exports;(function(n){(function(e,t,a){function s(c){var r=this,o="";r.next=function(){var d=r.x^r.x>>>2;return r.x=r.y,r.y=r.z,r.z=r.w,r.w=r.v,(r.d=r.d+362437|0)+(r.v=r.v^r.v<<4^(d^d<<1))|0},r.x=0,r.y=0,r.z=0,r.w=0,r.v=0,c===(c|0)?r.x=c:o+=c;for(var u=0;u<o.length+64;u++)r.x^=o.charCodeAt(u)|0,u==o.length&&(r.d=r.x<<10^r.x>>>4),r.next()}function i(c,r){return r.x=c.x,r.y=c.y,r.z=c.z,r.w=c.w,r.v=c.v,r.d=c.d,r}function l(c,r){var o=new s(c),u=r&&r.state,d=function(){return(o.next()>>>0)/4294967296};return d.double=function(){do var f=o.next()>>>11,h=(o.next()>>>0)/4294967296,w=(f+h)/(1<<21);while(w===0);return w},d.int32=o.next,d.quick=d,u&&(typeof u=="object"&&i(u,o),d.state=function(){return i(o,{})}),d}t&&t.exports?t.exports=l:this.xorwow=l})(z,n)})(ne);var Ge=ne.exports,se={exports:{}};se.exports;(function(n){(function(e,t,a){function s(c){var r=this;r.next=function(){var u=r.x,d=r.i,f,h;return f=u[d],f^=f>>>7,h=f^f<<24,f=u[d+1&7],h^=f^f>>>10,f=u[d+3&7],h^=f^f>>>3,f=u[d+4&7],h^=f^f<<7,f=u[d+7&7],f=f^f<<13,h^=f^f<<9,u[d]=h,r.i=d+1&7,h};function o(u,d){var f,h=[];if(d===(d|0))h[0]=d;else for(d=""+d,f=0;f<d.length;++f)h[f&7]=h[f&7]<<15^d.charCodeAt(f)+h[f+1&7]<<13;for(;h.length<8;)h.push(0);for(f=0;f<8&&h[f]===0;++f);for(f==8?h[7]=-1:h[f],u.x=h,u.i=0,f=256;f>0;--f)u.next()}o(r,c)}function i(c,r){return r.x=c.x.slice(),r.i=c.i,r}function l(c,r){c==null&&(c=+new Date);var o=new s(c),u=r&&r.state,d=function(){return(o.next()>>>0)/4294967296};return d.double=function(){do var f=o.next()>>>11,h=(o.next()>>>0)/4294967296,w=(f+h)/(1<<21);while(w===0);return w},d.int32=o.next,d.quick=d,u&&(u.x&&i(u,o),d.state=function(){return i(o,{})}),d}t&&t.exports?t.exports=l:this.xorshift7=l})(z,n)})(se);var Oe=se.exports,ie={exports:{}};ie.exports;(function(n){(function(e,t,a){function s(c){var r=this;r.next=function(){var u=r.w,d=r.X,f=r.i,h,w;return r.w=u=u+1640531527|0,w=d[f+34&127],h=d[f=f+1&127],w^=w<<13,h^=h<<17,w^=w>>>15,h^=h>>>12,w=d[f]=w^h,r.i=f,w+(u^u>>>16)|0};function o(u,d){var f,h,w,D,T,C=[],j=128;for(d===(d|0)?(h=d,d=null):(d=d+"\0",h=0,j=Math.max(j,d.length)),w=0,D=-32;D<j;++D)d&&(h^=d.charCodeAt((D+32)%d.length)),D===0&&(T=h),h^=h<<10,h^=h>>>15,h^=h<<4,h^=h>>>13,D>=0&&(T=T+1640531527|0,f=C[D&127]^=h+T,w=f==0?w+1:0);for(w>=128&&(C[(d&&d.length||0)&127]=-1),w=127,D=4*128;D>0;--D)h=C[w+34&127],f=C[w=w+1&127],h^=h<<13,f^=f<<17,h^=h>>>15,f^=f>>>12,C[w]=h^f;u.w=T,u.X=C,u.i=w}o(r,c)}function i(c,r){return r.i=c.i,r.w=c.w,r.X=c.X.slice(),r}function l(c,r){c==null&&(c=+new Date);var o=new s(c),u=r&&r.state,d=function(){return(o.next()>>>0)/4294967296};return d.double=function(){do var f=o.next()>>>11,h=(o.next()>>>0)/4294967296,w=(f+h)/(1<<21);while(w===0);return w},d.int32=o.next,d.quick=d,u&&(u.X&&i(u,o),d.state=function(){return i(o,{})}),d}t&&t.exports?t.exports=l:this.xor4096=l})(z,n)})(ie);var qe=ie.exports,oe={exports:{}};oe.exports;(function(n){(function(e,t,a){function s(c){var r=this,o="";r.next=function(){var d=r.b,f=r.c,h=r.d,w=r.a;return d=d<<25^d>>>7^f,f=f-h|0,h=h<<24^h>>>8^w,w=w-d|0,r.b=d=d<<20^d>>>12^f,r.c=f=f-h|0,r.d=h<<16^f>>>16^w,r.a=w-d|0},r.a=0,r.b=0,r.c=-1640531527,r.d=1367130551,c===Math.floor(c)?(r.a=c/4294967296|0,r.b=c|0):o+=c;for(var u=0;u<o.length+20;u++)r.b^=o.charCodeAt(u)|0,r.next()}function i(c,r){return r.a=c.a,r.b=c.b,r.c=c.c,r.d=c.d,r}function l(c,r){var o=new s(c),u=r&&r.state,d=function(){return(o.next()>>>0)/4294967296};return d.double=function(){do var f=o.next()>>>11,h=(o.next()>>>0)/4294967296,w=(f+h)/(1<<21);while(w===0);return w},d.int32=o.next,d.quick=d,u&&(typeof u=="object"&&i(u,o),d.state=function(){return i(o,{})}),d}t&&t.exports?t.exports=l:this.tychei=l})(z,n)})(oe);var Ue=oe.exports,ve={exports:{}};const He={},Ve=Object.freeze(Object.defineProperty({__proto__:null,default:He},Symbol.toStringTag,{value:"Module"})),Ke=_e(Ve);(function(n){(function(e,t,a){var s=256,i=6,l=52,c="random",r=a.pow(s,i),o=a.pow(2,l),u=o*2,d=s-1,f;function h(p,v,I){var b=[];v=v==!0?{entropy:!0}:v||{};var m=C(T(v.entropy?[p,_(t)]:p??j(),3),b),S=new w(b),k=function(){for(var A=S.g(i),N=r,R=0;A<o;)A=(A+R)*s,N*=s,R=S.g(1);for(;A>=u;)A/=2,N/=2,R>>>=1;return(A+R)/N};return k.int32=function(){return S.g(4)|0},k.quick=function(){return S.g(4)/4294967296},k.double=k,C(_(S.S),t),(v.pass||I||function(A,N,R,L){return L&&(L.S&&D(L,S),A.state=function(){return D(S,{})}),R?(a[c]=A,N):A})(k,m,"global"in v?v.global:this==a,v.state)}function w(p){var v,I=p.length,b=this,m=0,S=b.i=b.j=0,k=b.S=[];for(I||(p=[I++]);m<s;)k[m]=m++;for(m=0;m<s;m++)k[m]=k[S=d&S+p[m%I]+(v=k[m])],k[S]=v;(b.g=function(A){for(var N,R=0,L=b.i,q=b.j,G=b.S;A--;)N=G[L=d&L+1],R=R*s+G[d&(G[L]=G[q=d&q+N])+(G[q]=N)];return b.i=L,b.j=q,R})(s)}function D(p,v){return v.i=p.i,v.j=p.j,v.S=p.S.slice(),v}function T(p,v){var I=[],b=typeof p,m;if(v&&b=="object")for(m in p)try{I.push(T(p[m],v-1))}catch{}return I.length?I:b=="string"?p:p+"\0"}function C(p,v){for(var I=p+"",b,m=0;m<I.length;)v[d&m]=d&(b^=v[d&m]*19)+I.charCodeAt(m++);return _(v)}function j(){try{var p;return f&&(p=f.randomBytes)?p=p(s):(p=new Uint8Array(s),(e.crypto||e.msCrypto).getRandomValues(p)),_(p)}catch{var v=e.navigator,I=v&&v.plugins;return[+new Date,e,I,e.screen,_(t)]}}function _(p){return String.fromCharCode.apply(0,p)}if(C(a.random(),t),n.exports){n.exports=h;try{f=Ke}catch{}}else a["seed"+c]=h})(typeof self<"u"?self:z,[],Math)})(ve);var Xe=ve.exports,We=je,Ye=Pe,Ze=Ge,Qe=Oe,Je=qe,et=Ue,$=Xe;$.alea=We;$.xor128=Ye;$.xorwow=Ze;$.xorshift7=Qe;$.xor4096=Je;$.tychei=et;var tt=$;const at=De(tt);var g=(n=>(n[n.New=0]="New",n[n.Learning=1]="Learning",n[n.Review=2]="Review",n[n.Relearning=3]="Relearning",n))(g||{}),y=(n=>(n[n.Manual=0]="Manual",n[n.Again=1]="Again",n[n.Hard=2]="Hard",n[n.Good=3]="Good",n[n.Easy=4]="Easy",n))(y||{});Date.prototype.scheduler=function(n,e){return B(this,n,e)},Date.prototype.diff=function(n,e){return rt(this,n,e)},Date.prototype.format=function(){return nt(this)},Date.prototype.dueFormat=function(n,e,t){return st(this,n,e,t)};function B(n,e,t){return new Date(t?E(n).getTime()+e*24*60*60*1e3:E(n).getTime()+e*60*1e3)}function rt(n,e,t){if(!n||!e)throw new Error("Invalid date");const a=E(n).getTime()-E(e).getTime();let s=0;switch(t){case"days":s=Math.floor(a/(24*60*60*1e3));break;case"minutes":s=Math.floor(a/(60*1e3));break}return s}function nt(n){const e=E(n),t=e.getFullYear(),a=e.getMonth()+1,s=e.getDate(),i=e.getHours(),l=e.getMinutes(),c=e.getSeconds();return`${t}-${O(a)}-${O(s)} ${O(i)}:${O(l)}:${O(c)}`}function O(n){return n<10?`0${n}`:`${n}`}const K=[60,60,24,31,12],X=["second","min","hour","day","month","year"];function st(n,e,t,a=X){n=E(n),e=E(e),a.length!==X.length&&(a=X);let s=n.getTime()-e.getTime(),i;for(s/=1e3,i=0;i<K.length&&!(s<K[i]);i++)s/=K[i];return`${Math.floor(s)}${t?a[i]:""}`}function E(n){if(typeof n=="object"&&n instanceof Date)return n;if(typeof n=="string"){const e=Date.parse(n);if(isNaN(e))throw new Error(`Invalid date:[${n}]`);return new Date(e)}else if(typeof n=="number")return new Date(n);throw new Error(`Invalid date:[${n}]`)}function W(n){if(typeof n=="string"){const e=n.charAt(0).toUpperCase(),t=n.slice(1).toLowerCase(),a=g[`${e}${t}`];if(a===void 0)throw new Error(`Invalid state:[${n}]`);return a}else if(typeof n=="number")return n;throw new Error(`Invalid state:[${n}]`)}function it(n){if(typeof n=="string"){const e=n.charAt(0).toUpperCase(),t=n.slice(1).toLowerCase(),a=y[`${e}${t}`];if(a===void 0)throw new Error(`Invalid rating:[${n}]`);return a}else if(typeof n=="number")return n;throw new Error(`Invalid rating:[${n}]`)}y.Again,y.Hard,y.Good,y.Easy;const ot=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function ct(n,e,t){let a=1;for(const l of ot)a+=l.factor*Math.max(Math.min(n,l.end)-l.start,0);n=Math.min(n,t);let s=Math.max(2,Math.round(n-a));const i=Math.min(Math.round(n+a),t);return n>e&&(s=Math.max(s,e+1)),s=Math.min(s,i),{min_ivl:s,max_ivl:i}}class dt{again;hard;good;easy;last_review;last_elapsed_days;copy(e){return{...e}}constructor(e,t){this.last_review=e.last_review||e.due,this.last_elapsed_days=e.elapsed_days,e.elapsed_days=e.state===g.New?0:t.diff(e.last_review,"days"),e.last_review=t,e.reps+=1,this.again=this.copy(e),this.hard=this.copy(e),this.good=this.copy(e),this.easy=this.copy(e)}update_state(e){return e===g.New?(this.again.state=g.Learning,this.hard.state=g.Learning,this.good.state=g.Learning,this.easy.state=g.Review):e===g.Learning||e===g.Relearning?(this.again.state=e,this.hard.state=e,this.good.state=g.Review,this.easy.state=g.Review):e===g.Review&&(this.again.state=g.Relearning,this.hard.state=g.Review,this.good.state=g.Review,this.easy.state=g.Review,this.again.lapses+=1),this}schedule(e,t,a,s){return this.again.scheduled_days=0,this.hard.scheduled_days=t,this.good.scheduled_days=a,this.easy.scheduled_days=s,this.again.due=B(e,5),this.hard.due=t>0?B(e,t,!0):B(e,10),this.good.due=B(e,a,!0),this.easy.due=B(e,s,!0),this}record_log(e,t){return{[y.Again]:{card:this.again,log:{rating:y.Again,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:t}},[y.Hard]:{card:this.hard,log:{rating:y.Hard,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:t}},[y.Good]:{card:this.good,log:{rating:y.Good,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:t}},[y.Easy]:{card:this.easy,log:{rating:y.Easy,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:t}}}}}const ut=.9,lt=36500,ft=[.5701,1.4436,4.1386,10.9355,5.1443,1.2006,.8627,.0362,1.629,.1342,1.0166,2.1174,.0839,.3204,1.4676,.219,2.8237],ht=!1,te=n=>({request_retention:n?.request_retention||ut,maximum_interval:n?.maximum_interval||lt,w:n?.w||ft,enable_fuzz:n?.enable_fuzz||ht}),he=-.5,we=19/81;class wt{param;intervalModifier;seed;constructor(e){this.param=new Proxy(te(e),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention)}get interval_modifier(){return this.intervalModifier}calculate_interval_modifier(e){if(e<=0||e>1)throw new Error("Requested retention rate should be in the range (0,1]");return+((Math.pow(e,1/he)-1)/we).toFixed(8)}get parameters(){return this.param}set parameters(e){this.update_parameters(e)}params_handler_proxy(){const e=this;return{set:function(t,a,s){return a==="request_retention"&&Number.isFinite(s)&&(e.intervalModifier=e.calculate_interval_modifier(Number(s))),t[a]=s,!0}}}update_parameters(e){const t=te(e);for(const a in t)if(a in this.param){const s=a;this.param[s]=t[s]}}init_ds(e){e.again.difficulty=this.init_difficulty(y.Again),e.again.stability=this.init_stability(y.Again),e.hard.difficulty=this.init_difficulty(y.Hard),e.hard.stability=this.init_stability(y.Hard),e.good.difficulty=this.init_difficulty(y.Good),e.good.stability=this.init_stability(y.Good),e.easy.difficulty=this.init_difficulty(y.Easy),e.easy.stability=this.init_stability(y.Easy)}next_ds(e,t,a,s){e.again.difficulty=this.next_difficulty(t,y.Again),e.again.stability=this.next_forget_stability(t,a,s),e.hard.difficulty=this.next_difficulty(t,y.Hard),e.hard.stability=this.next_recall_stability(t,a,s,y.Hard),e.good.difficulty=this.next_difficulty(t,y.Good),e.good.stability=this.next_recall_stability(t,a,s,y.Good),e.easy.difficulty=this.next_difficulty(t,y.Easy),e.easy.stability=this.next_recall_stability(t,a,s,y.Easy)}init_stability(e){return Math.max(this.param.w[e-1],.1)}init_difficulty(e){return+Math.min(Math.max(this.param.w[4]-(e-3)*this.param.w[5],1),10).toFixed(8)}apply_fuzz(e,t,a){if(!a||e<2.5)return Math.round(e);const s=at(this.seed)(),{min_ivl:i,max_ivl:l}=ct(e,t,this.param.maximum_interval);return Math.floor(s*(l-i+1)+i)}next_interval(e,t,a=this.param.enable_fuzz){const s=Math.min(Math.max(1,Math.round(e*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(s,t,a)}next_difficulty(e,t){const a=e-this.param.w[6]*(t-3);return this.constrain_difficulty(this.mean_reversion(this.param.w[4],a))}constrain_difficulty(e){return Math.min(Math.max(+e.toFixed(8),1),10)}mean_reversion(e,t){return+(this.param.w[7]*e+(1-this.param.w[7])*t).toFixed(8)}next_recall_stability(e,t,a,s){const i=y.Hard===s?this.param.w[15]:1,l=y.Easy===s?this.param.w[16]:1;return+(t*(1+Math.exp(this.param.w[8])*(11-e)*Math.pow(t,-this.param.w[9])*(Math.exp((1-a)*this.param.w[10])-1)*i*l)).toFixed(8)}next_forget_stability(e,t,a){return+(this.param.w[11]*Math.pow(e,-this.param.w[12])*(Math.pow(t+1,this.param.w[13])-1)*Math.exp((1-a)*this.param.w[14])).toFixed(8)}forgetting_curve(e,t){return+Math.pow(1+we*e/t,he).toFixed(8)}}class yt extends wt{constructor(e){super(e)}preProcessCard(e){return{...e,state:W(e.state),due:E(e.due),last_review:e.last_review?E(e.last_review):void 0}}preProcessDate(e){return E(e)}preProcessLog(e){return{...e,due:E(e.due),rating:it(e.rating),state:W(e.state),review:E(e.review)}}repeat(e,t,a){const s=this.preProcessCard(e);t=this.preProcessDate(t);const i=new dt(s,t).update_state(s.state);this.seed=String(t.getTime())+String(s.reps);let l,c,r;const o=s.elapsed_days;switch(s.state){case g.New:this.init_ds(i),i.again.due=t.scheduler(1),i.hard.due=t.scheduler(5),i.good.due=t.scheduler(10),l=this.next_interval(i.easy.stability,o),i.easy.scheduled_days=l,i.easy.due=t.scheduler(l,!0);break;case g.Learning:case g.Relearning:r=0,c=this.next_interval(i.good.stability,o),l=Math.max(this.next_interval(i.easy.stability,o),c+1),i.schedule(t,r,c,l);break;case g.Review:{const d=s.difficulty,f=s.stability,h=this.forgetting_curve(o,f);this.next_ds(i,d,f,h),r=this.next_interval(i.hard.stability,o),c=this.next_interval(i.good.stability,o),r=Math.min(r,c),c=Math.max(c,r+1),l=Math.max(this.next_interval(i.easy.stability,o),c+1),i.schedule(t,r,c,l);break}}const u=i.record_log(s,t);return a&&typeof a=="function"?a(u):u}get_retrievability(e,t,a=!0){const s=this.preProcessCard(e);if(t=this.preProcessDate(t),s.state!==g.Review)return;const i=Math.max(t.diff(s.last_review,"days"),0),l=this.forgetting_curve(i,Math.round(s.stability));return a?`${(l*100).toFixed(2)}%`:l}rollback(e,t,a){const s=this.preProcessCard(e),i=this.preProcessLog(t);if(i.rating===y.Manual)throw new Error("Cannot rollback a manual rating");let l,c,r;switch(i.state){case g.New:l=i.due,c=void 0,r=0;break;case g.Learning:case g.Relearning:case g.Review:l=i.review,c=i.due,r=s.lapses-(i.rating===y.Again&&i.state===g.Review?1:0);break}const o={...s,due:l,stability:i.stability,difficulty:i.difficulty,elapsed_days:i.last_elapsed_days,scheduled_days:i.scheduled_days,reps:Math.max(0,s.reps-1),lapses:Math.max(0,r),state:i.state,last_review:c};return a&&typeof a=="function"?a(o):o}forget(e,t,a=!1,s){const i=this.preProcessCard(e);t=this.preProcessDate(t);const l=i.state===g.New?0:t.diff(i.last_review,"days"),c={rating:y.Manual,state:i.state,due:i.due,stability:i.stability,difficulty:i.difficulty,elapsed_days:0,last_elapsed_days:i.elapsed_days,scheduled_days:l,review:t},r={card:{...i,due:t,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:a?0:i.reps,lapses:a?0:i.lapses,state:g.New,last_review:i.last_review},log:c};return s&&typeof s=="function"?s(r):r}reschedule(e,t={}){if(!Array.isArray(e))throw new Error("cards must be an array");const a=[];for(const s of e){if(W(s.state)!==g.Review||!s.last_review)continue;const i=Math.floor(s.scheduled_days),l=this.next_interval(+s.stability.toFixed(2),Math.round(s.elapsed_days),t.enable_fuzz??!0);if(l===i||l===0)continue;const c={...s};c.scheduled_days=l;const r=B(c.last_review,l,!0);t.dateHandler&&typeof t.dateHandler=="function"?c.due=t.dateHandler(r):c.due=r,a.push(c)}return a}}class xe{constructor(){this.userSettings={learningSteps:"1 10",relearningSteps:"10",dailyNewCardsLimit:20,dailyReviewLimit:200},this.config={...ye},this.fsrsInstance=this.createFSRSInstance(this.config),this.initializeUserSettings()}async initializeUserSettings(){try{this.userSettings=await me(),be(e=>{this.userSettings={...this.userSettings,...e},console.log("FSRS service updated with new settings:",this.userSettings)})}catch(e){console.error("Failed to initialize user settings:",e)}}createFSRSInstance(e){const t=te({request_retention:e.requestRetention,maximum_interval:e.maximumInterval,enable_fuzz:!0});return new yt(t)}convertToFSRSCard(e){return{due:e.due,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsedDays,scheduled_days:e.scheduledDays,reps:e.reps,lapses:e.lapses,state:this.convertToFSRSState(e.state),last_review:e.lastReview||void 0}}convertToAppCard(e){return{due:e.due,stability:e.stability,difficulty:e.difficulty,elapsedDays:e.elapsed_days,scheduledDays:e.scheduled_days,reps:e.reps,lapses:e.lapses,state:this.convertFromFSRSState(e.state),lastReview:e.last_review}}convertToFSRSState(e){switch(e){case"New":return g.New;case"Learning":return g.Learning;case"Review":return g.Review;case"Relearning":return g.Relearning;default:return g.New}}convertFromFSRSState(e){switch(e){case g.New:return"New";case g.Learning:return"Learning";case g.Review:return"Review";case g.Relearning:return"Relearning";default:return"New"}}mapRatingToFSRS(e){switch(e){case"Again":return y.Again;case"Hard":return y.Hard;case"Good":return y.Good;case"Easy":return y.Easy;default:return y.Good}}async reviewCard(e,t){try{const a=await x.getCardById(e);if(!a)throw new Error(`Card with id ${e} not found`);const s=new Date,i=this.convertToFSRSCard(a),l=this.mapRatingToFSRS(t),r=this.fsrsInstance.repeat(i,s)[l],o=this.convertToAppCard(r.card),u=await x.updateCard(e,o);return await x.addReviewLog({cardId:e,reviewTime:s,rating:this.convertAppRatingToNumber(t),stateBefore:a.state,stateAfter:u.state,stabilityBefore:a.stability,stabilityAfter:u.stability,difficultyBefore:a.difficulty,difficultyAfter:u.difficulty,interval:u.scheduledDays,lastInterval:a.scheduledDays}),{success:!0,nextReview:u.due,interval:u.scheduledDays}}catch(a){return console.error("Error reviewing card:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}convertAppRatingToNumber(e){switch(e){case"Again":return 1;case"Hard":return 2;case"Good":return 3;case"Easy":return 4;default:return 3}}async getNextReviewDate(e,t){const a=this.convertToFSRSCard(e),s=this.mapRatingToFSRS(t);return this.fsrsInstance.repeat(a,new Date)[s].card.due}async predictRetention(e){const a=(new Date().getTime()-e.due.getTime())/(1e3*60*60*24);return e.stability>0?Math.exp(-a/e.stability):.9}async calculateLearningProgress(e){const t=e.length,a=e.filter(o=>o.state==="New").length,s=e.filter(o=>o.state==="Learning").length,i=e.filter(o=>o.state==="Review").length;let l=0,c=0;for(const o of e)if(o.state==="Review"&&o.stability>0){const u=await this.predictRetention(o);l+=u,c++}const r=c>0?l/c:.9;return{totalCards:t,newCards:a,learningCards:s,reviewCards:i,averageRetention:r,studyStreak:0}}async recommendStudySchedule(e){const t=new Date,a=e.filter(c=>c.due<=t).length,s=new Date(t);s.setDate(s.getDate()+1);const i=e.filter(c=>c.due>t&&c.due<=s).length,l=Math.max(20,Math.min(50,a+10));return{immediateReview:a,todayTotal:a,tomorrowTotal:i,recommendedDailyLimit:l}}updateConfig(e){if(e.requestRetention!==void 0&&(e.requestRetention<=0||e.requestRetention>1))throw new Error("Request retention must be between 0 and 1");if(e.maximumInterval!==void 0&&e.maximumInterval<0)throw new Error("Maximum interval must be non-negative");if(e.easyBonus!==void 0&&e.easyBonus<1)throw new Error("Easy bonus must be >= 1");if(e.hardFactor!==void 0&&e.hardFactor<=0)throw new Error("Hard factor must be positive");this.config={...this.config,...e},this.fsrsInstance=this.createFSRSInstance(this.config)}getConfig(){return{...this.config}}}new xe;const M=new xe;class gt{constructor(){this.initialized=!1}get isInitialized(){return this.initialized}async init(){if(!this.initialized)try{console.log("Initializing AnGear Background Service..."),await x.initDatabase(),await this.setupAlarms(),await this.initializeDefaultConfig(),this.initialized=!0,console.log("AnGear Background Service initialized successfully"),await this.updateBadge()}catch(e){throw console.error("Failed to initialize background service:",e),e}}async initializeWithRetry(e=3){if(this.initialized)return;let t;for(let s=1;s<=e;s++)try{if(console.log(`Initialization attempt ${s}/${e}`),await this.init(),this.initialized){console.log(`Initialization successful on attempt ${s}`);return}}catch(i){if(t=i instanceof Error?i:new Error(String(i)),console.error(`Initialization attempt ${s} failed:`,t.message),s<e){const l=s*1e3;console.log(`Waiting ${l}ms before retry...`),await new Promise(c=>setTimeout(c,l))}}const a=new Error(`Failed to initialize after ${e} attempts. Last error: ${t?.message||"Unknown error"}`);throw console.error("Critical initialization failure:",a.message),a}async setupAlarms(){await chrome.alarms.clearAll(),await chrome.alarms.create("daily-check",{delayInMinutes:1,periodInMinutes:60}),await chrome.alarms.create("health-check",{delayInMinutes:5,periodInMinutes:30}),console.log("Alarms set up successfully")}async initializeDefaultConfig(){console.log("Using default FSRS configuration")}async updateBadge(){try{const t=(await x.getDueCards()).length;t>0?(await chrome.action.setBadgeText({text:t>99?"99+":t.toString()}),await chrome.action.setBadgeBackgroundColor({color:"#E53E3E"})):await chrome.action.setBadgeText({text:""})}catch(e){console.error("Failed to update badge:",e)}}async handleAlarm(e){switch(e.name){case"daily-check":console.log("Running daily check..."),await this.updateBadge();break;default:console.log(`Unknown alarm: ${e.name}`)}}async handleMessage(e,t){try{switch(console.log(`Received message: ${e.type}`,e),this.initialized||(console.log("Service not initialized, attempting initialization..."),await this.initializeWithRetry()),e.type){case"CREATE_DECK":const a=await x.createDeck(e.payload);return await this.updateBadge(),{success:!0,data:a};case"GET_ALL_DECKS":return{success:!0,data:await x.getAllDecks()};case"GET_DECK_BY_ID":return{success:!0,data:await x.getDeckById(e.payload.id)};case"UPDATE_DECK":return await x.updateDeck(e.payload.id,e.payload.updates),{success:!0};case"DELETE_DECK":return await x.deleteDeck(e.payload.id),await this.updateBadge(),{success:!0};case"GET_DECK_STATS":return{success:!0,data:await x.getDeckStatistics(e.payload.deckId)};case"CREATE_NOTE":try{console.log("Creating note with payload:",e.payload);const _=await x.createNote(e.payload);return await x.createCardsForNote(_),await this.updateBadge(),console.log("Note and cards created successfully:",_.id),{success:!0,data:_}}catch(_){if(console.error("CREATE_NOTE operation failed:",_),_ instanceof Error){if(_.message.includes("Duplicate key conflict"))return{success:!1,error:"Note creation failed due to database conflict. Please try again or restart the extension."};if(_.name==="ConstraintError"||_.message.includes("Key already exists"))return{success:!1,error:"Database constraint violation: A note with this identifier already exists. Please refresh the page and try again."}}throw _}case"GET_NOTES_BY_DECK":return{success:!0,data:await x.getNotesByDeckId(e.payload.deckId)};case"UPDATE_NOTE":return await x.updateNote(e.payload.id,e.payload.updates),{success:!0};case"DELETE_NOTE":return await x.deleteNote(e.payload.id),await this.updateBadge(),{success:!0};case"GET_NOTE_BY_ID":return{success:!0,data:await x.getNoteById(e.payload.id)};case"GET_DUE_CARDS":return{success:!0,data:await x.getDueCards(e.payload?.deckId,e.payload?.limit)};case"REVIEW_CARD":const u=await M.reviewCard(e.payload.cardId,e.payload.rating);return await this.updateBadge(),{success:!0,data:u};case"GET_CARD_PREDICTIONS":const d=await x.getCardById(e.payload.cardId);return d?{success:!0,data:{again:await M.getNextReviewDate(d,"Again"),hard:await M.getNextReviewDate(d,"Hard"),good:await M.getNextReviewDate(d,"Good"),easy:await M.getNextReviewDate(d,"Easy")}}:{success:!1,error:"Card not found"};case"GET_CARDS_BY_DECK":return{success:!0,data:await x.getCardsByDeckId(e.payload.deckId)};case"RESET_CARD_PROGRESS":return await x.resetCardProgress(e.payload.cardId),await this.updateBadge(),{success:!0};case"GET_FSRS_CONFIG":return{success:!0,data:M.getConfig()};case"UPDATE_FSRS_CONFIG":return M.updateConfig(e.payload),{success:!0};case"GET_FSRS_STATS":const D=await x.getCardsByDeckId(e.payload.deckId);return{success:!0,data:await M.calculateLearningProgress(D)};case"GET_USER_CONFIG":return{success:!0,data:{theme:"auto",language:"zh-CN"}};case"SAVE_USER_CONFIG":return{success:!0};case"GET_DATABASE_SIZE":return{success:!0,data:{decks:(await x.getAllDecks()).length}};case"VALIDATE_DATABASE_INTEGRITY":return{success:!0,data:await x.validateDatabaseIntegrity()};case"CLEAR_ALL_DATA":return await x.clearAllData(),await this.updateBadge(),{success:!0};case"STORE_AUDIO":return{success:!1,error:"Audio storage not implemented yet"};case"GET_AUDIO":return{success:!1,error:"Audio retrieval not implemented yet"};case"DELETE_AUDIO":return{success:!1,error:"Audio deletion not implemented yet"};default:return console.warn(`Unknown message type: ${e.type}`),{success:!1,error:`Unknown message type: ${e.type}`}}}catch(a){return console.error(`Error handling message ${e.type}:`,a),a instanceof Error&&a.message.includes("Failed to initialize")?{success:!1,error:"应用初始化失败，请尝试重新加载扩展。如果问题持续存在，请检查浏览器控制台获取详细错误信息。"}:a instanceof Error&&a.message.includes("Database not initialized")?{success:!1,error:"数据库连接失败，正在尝试重新连接...请稍后重试。"}:{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}getCardTemplatesForNoteType(e){switch(e){case"CtoE":return["CtoE_ZhToEn"];case"Retranslate":return["Retranslate_Forward","Retranslate_Backward"];case"SentenceParaphrase":return["SentenceParaphrase_Listen","SentenceParaphrase_Speak"];case"Article":return["Article_Reading","Article_Questions"];default:return["Basic"]}}}const P=new gt;chrome.runtime.onStartup.addListener(async()=>{console.log("Extension startup");try{await P.init()}catch(n){console.error("Failed to initialize on startup:",n)}});chrome.runtime.onInstalled.addListener(async()=>{console.log("Extension installed");try{await P.init()}catch(n){console.error("Failed to initialize on install:",n)}});chrome.runtime.onMessage.addListener((n,e,t)=>(P.handleMessage(n,e).then(a=>t(a)).catch(a=>{console.error("Message handling error:",a),t({success:!1,error:a instanceof Error?a.message:"Unknown error"})}),!0));chrome.alarms.onAlarm.addListener(async n=>{if(n.name==="health-check")try{P.isInitialized||(console.log("Health check detected uninitialized service, attempting recovery..."),await P.init())}catch(e){console.error("Health check initialization failed:",e)}await P.handleAlarm(n)});chrome.action.onClicked.addListener(async n=>{await chrome.tabs.create({url:chrome.runtime.getURL("main.html")})});console.log("AnGear Background Script loaded");
