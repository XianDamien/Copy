import{b as oe,g as ce,c as le,d as p,p as ee}from"../../db-0AuwIzuQ.js";import{c as B,a as ue,g as de}from"../../_commonjsHelpers-BosuxZz1.js";const he=function(){const e=typeof document<"u"&&document.createElement("link").relList;return e&&e.supports&&e.supports("modulepreload")?"modulepreload":"preload"}(),fe=function(c){return"/"+c},te={},q=function(e,t,r){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),s=d?.nonce||d?.getAttribute("nonce");i=Promise.allSettled(t.map(a=>{if(a=fe(a),a in te)return;te[a]=!0;const n=a.endsWith(".css"),h=n?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${a}"]${h}`))return;const l=document.createElement("link");if(l.rel=n?"stylesheet":he,n||(l.as="script"),l.crossOrigin="",l.href=a,s&&l.setAttribute("nonce",s),document.head.appendChild(l),n)return new Promise((u,f)=>{l.addEventListener("load",u),l.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${a}`)))})}))}function o(d){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=d,window.dispatchEvent(s),!s.defaultPrevented)throw d}return i.then(d=>{for(const s of d||[])s.status==="rejected"&&o(s.reason);return e().catch(o)})};var Y={exports:{}};Y.exports;(function(c){(function(e,t,r){function i(a){var n=this,h=s();n.next=function(){var l=2091639*n.s0+n.c*23283064365386963e-26;return n.s0=n.s1,n.s1=n.s2,n.s2=l-(n.c=l|0)},n.c=1,n.s0=h(" "),n.s1=h(" "),n.s2=h(" "),n.s0-=h(a),n.s0<0&&(n.s0+=1),n.s1-=h(a),n.s1<0&&(n.s1+=1),n.s2-=h(a),n.s2<0&&(n.s2+=1),h=null}function o(a,n){return n.c=a.c,n.s0=a.s0,n.s1=a.s1,n.s2=a.s2,n}function d(a,n){var h=new i(a),l=n&&n.state,u=h.next;return u.int32=function(){return h.next()*4294967296|0},u.double=function(){return u()+(u()*2097152|0)*11102230246251565e-32},u.quick=u,l&&(typeof l=="object"&&o(l,h),u.state=function(){return o(h,{})}),u}function s(){var a=4022871197,n=function(h){h=String(h);for(var l=0;l<h.length;l++){a+=h.charCodeAt(l);var u=.02519603282416938*a;a=u>>>0,u-=a,u*=a,a=u>>>0,u-=a,a+=u*4294967296}return(a>>>0)*23283064365386963e-26};return n}t&&t.exports?t.exports=d:this.alea=d})(B,c)})(Y);var pe=Y.exports,V={exports:{}};V.exports;(function(c){(function(e,t,r){function i(s){var a=this,n="";a.x=0,a.y=0,a.z=0,a.w=0,a.next=function(){var l=a.x^a.x<<11;return a.x=a.y,a.y=a.z,a.z=a.w,a.w^=a.w>>>19^l^l>>>8},s===(s|0)?a.x=s:n+=s;for(var h=0;h<n.length+64;h++)a.x^=n.charCodeAt(h)|0,a.next()}function o(s,a){return a.x=s.x,a.y=s.y,a.z=s.z,a.w=s.w,a}function d(s,a){var n=new i(s),h=a&&a.state,l=function(){return(n.next()>>>0)/4294967296};return l.double=function(){do var u=n.next()>>>11,f=(n.next()>>>0)/4294967296,y=(u+f)/(1<<21);while(y===0);return y},l.int32=n.next,l.quick=l,h&&(typeof h=="object"&&o(h,n),l.state=function(){return o(n,{})}),l}t&&t.exports?t.exports=d:this.xor128=d})(B,c)})(V);var ye=V.exports,Q={exports:{}};Q.exports;(function(c){(function(e,t,r){function i(s){var a=this,n="";a.next=function(){var l=a.x^a.x>>>2;return a.x=a.y,a.y=a.z,a.z=a.w,a.w=a.v,(a.d=a.d+362437|0)+(a.v=a.v^a.v<<4^(l^l<<1))|0},a.x=0,a.y=0,a.z=0,a.w=0,a.v=0,s===(s|0)?a.x=s:n+=s;for(var h=0;h<n.length+64;h++)a.x^=n.charCodeAt(h)|0,h==n.length&&(a.d=a.x<<10^a.x>>>4),a.next()}function o(s,a){return a.x=s.x,a.y=s.y,a.z=s.z,a.w=s.w,a.v=s.v,a.d=s.d,a}function d(s,a){var n=new i(s),h=a&&a.state,l=function(){return(n.next()>>>0)/4294967296};return l.double=function(){do var u=n.next()>>>11,f=(n.next()>>>0)/4294967296,y=(u+f)/(1<<21);while(y===0);return y},l.int32=n.next,l.quick=l,h&&(typeof h=="object"&&o(h,n),l.state=function(){return o(n,{})}),l}t&&t.exports?t.exports=d:this.xorwow=d})(B,c)})(Q);var we=Q.exports,W={exports:{}};W.exports;(function(c){(function(e,t,r){function i(s){var a=this;a.next=function(){var h=a.x,l=a.i,u,f;return u=h[l],u^=u>>>7,f=u^u<<24,u=h[l+1&7],f^=u^u>>>10,u=h[l+3&7],f^=u^u>>>3,u=h[l+4&7],f^=u^u<<7,u=h[l+7&7],u=u^u<<13,f^=u^u<<9,h[l]=f,a.i=l+1&7,f};function n(h,l){var u,f=[];if(l===(l|0))f[0]=l;else for(l=""+l,u=0;u<l.length;++u)f[u&7]=f[u&7]<<15^l.charCodeAt(u)+f[u+1&7]<<13;for(;f.length<8;)f.push(0);for(u=0;u<8&&f[u]===0;++u);for(u==8?f[7]=-1:f[u],h.x=f,h.i=0,u=256;u>0;--u)h.next()}n(a,s)}function o(s,a){return a.x=s.x.slice(),a.i=s.i,a}function d(s,a){s==null&&(s=+new Date);var n=new i(s),h=a&&a.state,l=function(){return(n.next()>>>0)/4294967296};return l.double=function(){do var u=n.next()>>>11,f=(n.next()>>>0)/4294967296,y=(u+f)/(1<<21);while(y===0);return y},l.int32=n.next,l.quick=l,h&&(h.x&&o(h,n),l.state=function(){return o(n,{})}),l}t&&t.exports?t.exports=d:this.xorshift7=d})(B,c)})(W);var ge=W.exports,Z={exports:{}};Z.exports;(function(c){(function(e,t,r){function i(s){var a=this;a.next=function(){var h=a.w,l=a.X,u=a.i,f,y;return a.w=h=h+1640531527|0,y=l[u+34&127],f=l[u=u+1&127],y^=y<<13,f^=f<<17,y^=y>>>15,f^=f>>>12,y=l[u]=y^f,a.i=u,y+(h^h>>>16)|0};function n(h,l){var u,f,y,R,T,A=[],$=128;for(l===(l|0)?(f=l,l=null):(l=l+"\0",f=0,$=Math.max($,l.length)),y=0,R=-32;R<$;++R)l&&(f^=l.charCodeAt((R+32)%l.length)),R===0&&(T=f),f^=f<<10,f^=f>>>15,f^=f<<4,f^=f>>>13,R>=0&&(T=T+1640531527|0,u=A[R&127]^=f+T,y=u==0?y+1:0);for(y>=128&&(A[(l&&l.length||0)&127]=-1),y=127,R=4*128;R>0;--R)f=A[y+34&127],u=A[y=y+1&127],f^=f<<13,u^=u<<17,f^=f>>>15,u^=u>>>12,A[y]=f^u;h.w=T,h.X=A,h.i=y}n(a,s)}function o(s,a){return a.i=s.i,a.w=s.w,a.X=s.X.slice(),a}function d(s,a){s==null&&(s=+new Date);var n=new i(s),h=a&&a.state,l=function(){return(n.next()>>>0)/4294967296};return l.double=function(){do var u=n.next()>>>11,f=(n.next()>>>0)/4294967296,y=(u+f)/(1<<21);while(y===0);return y},l.int32=n.next,l.quick=l,h&&(h.X&&o(h,n),l.state=function(){return o(n,{})}),l}t&&t.exports?t.exports=d:this.xor4096=d})(B,c)})(Z);var ve=Z.exports,J={exports:{}};J.exports;(function(c){(function(e,t,r){function i(s){var a=this,n="";a.next=function(){var l=a.b,u=a.c,f=a.d,y=a.a;return l=l<<25^l>>>7^u,u=u-f|0,f=f<<24^f>>>8^y,y=y-l|0,a.b=l=l<<20^l>>>12^u,a.c=u=u-f|0,a.d=f<<16^u>>>16^y,a.a=y-l|0},a.a=0,a.b=0,a.c=-1640531527,a.d=1367130551,s===Math.floor(s)?(a.a=s/4294967296|0,a.b=s|0):n+=s;for(var h=0;h<n.length+20;h++)a.b^=n.charCodeAt(h)|0,a.next()}function o(s,a){return a.a=s.a,a.b=s.b,a.c=s.c,a.d=s.d,a}function d(s,a){var n=new i(s),h=a&&a.state,l=function(){return(n.next()>>>0)/4294967296};return l.double=function(){do var u=n.next()>>>11,f=(n.next()>>>0)/4294967296,y=(u+f)/(1<<21);while(y===0);return y},l.int32=n.next,l.quick=l,h&&(typeof h=="object"&&o(h,n),l.state=function(){return o(n,{})}),l}t&&t.exports?t.exports=d:this.tychei=d})(B,c)})(J);var _e=J.exports,se={exports:{}};const xe={},me=Object.freeze(Object.defineProperty({__proto__:null,default:xe},Symbol.toStringTag,{value:"Module"})),Se=ue(me);(function(c){(function(e,t,r){var i=256,o=6,d=52,s="random",a=r.pow(i,o),n=r.pow(2,d),h=n*2,l=i-1,u;function f(_,x,w){var m=[];x=x==!0?{entropy:!0}:x||{};var S=A(T(x.entropy?[_,M(t)]:_??$(),3),m),E=new y(m),C=function(){for(var D=E.g(o),I=a,k=0;D<n;)D=(D+k)*i,I*=i,k=E.g(1);for(;D>=h;)D/=2,I/=2,k>>>=1;return(D+k)/I};return C.int32=function(){return E.g(4)|0},C.quick=function(){return E.g(4)/4294967296},C.double=C,A(M(E.S),t),(x.pass||w||function(D,I,k,L){return L&&(L.S&&R(L,E),D.state=function(){return R(E,{})}),k?(r[s]=D,I):D})(C,S,"global"in x?x.global:this==r,x.state)}function y(_){var x,w=_.length,m=this,S=0,E=m.i=m.j=0,C=m.S=[];for(w||(_=[w++]);S<i;)C[S]=S++;for(S=0;S<i;S++)C[S]=C[E=l&E+_[S%w]+(x=C[S])],C[E]=x;(m.g=function(D){for(var I,k=0,L=m.i,U=m.j,G=m.S;D--;)I=G[L=l&L+1],k=k*i+G[l&(G[L]=G[U=l&U+I])+(G[U]=I)];return m.i=L,m.j=U,k})(i)}function R(_,x){return x.i=_.i,x.j=_.j,x.S=_.S.slice(),x}function T(_,x){var w=[],m=typeof _,S;if(x&&m=="object")for(S in _)try{w.push(T(_[S],x-1))}catch{}return w.length?w:m=="string"?_:_+"\0"}function A(_,x){for(var w=_+"",m,S=0;S<w.length;)x[l&S]=l&(m^=x[l&S]*19)+w.charCodeAt(S++);return M(x)}function $(){try{var _;return u&&(_=u.randomBytes)?_=_(i):(_=new Uint8Array(i),(e.crypto||e.msCrypto).getRandomValues(_)),M(_)}catch{var x=e.navigator,w=x&&x.plugins;return[+new Date,e,w,e.screen,M(t)]}}function M(_){return String.fromCharCode.apply(0,_)}if(A(r.random(),t),c.exports){c.exports=f;try{u=Se}catch{}}else r["seed"+s]=f})(typeof self<"u"?self:B,[],Math)})(se);var Ee=se.exports,Ce=pe,Re=ye,De=we,be=ge,Ae=ve,ke=_e,z=Ee;z.alea=Ce;z.xor128=Re;z.xorwow=De;z.xorshift7=be;z.xor4096=Ae;z.tychei=ke;var Te=z;const Ie=de(Te);var g=(c=>(c[c.New=0]="New",c[c.Learning=1]="Learning",c[c.Review=2]="Review",c[c.Relearning=3]="Relearning",c))(g||{}),v=(c=>(c[c.Manual=0]="Manual",c[c.Again=1]="Again",c[c.Hard=2]="Hard",c[c.Good=3]="Good",c[c.Easy=4]="Easy",c))(v||{});Date.prototype.scheduler=function(c,e){return F(this,c,e)},Date.prototype.diff=function(c,e){return Me(this,c,e)},Date.prototype.format=function(){return Le(this)},Date.prototype.dueFormat=function(c,e,t){return Ne(this,c,e,t)};function F(c,e,t){return new Date(t?b(c).getTime()+e*24*60*60*1e3:b(c).getTime()+e*60*1e3)}function Me(c,e,t){if(!c||!e)throw new Error("Invalid date");const r=b(c).getTime()-b(e).getTime();let i=0;switch(t){case"days":i=Math.floor(r/(24*60*60*1e3));break;case"minutes":i=Math.floor(r/(60*1e3));break}return i}function Le(c){const e=b(c),t=e.getFullYear(),r=e.getMonth()+1,i=e.getDate(),o=e.getHours(),d=e.getMinutes(),s=e.getSeconds();return`${t}-${P(r)}-${P(i)} ${P(o)}:${P(d)}:${P(s)}`}function P(c){return c<10?`0${c}`:`${c}`}const H=[60,60,24,31,12],K=["second","min","hour","day","month","year"];function Ne(c,e,t,r=K){c=b(c),e=b(e),r.length!==K.length&&(r=K);let i=c.getTime()-e.getTime(),o;for(i/=1e3,o=0;o<H.length&&!(i<H[o]);o++)i/=H[o];return`${Math.floor(i)}${t?r[o]:""}`}function b(c){if(typeof c=="object"&&c instanceof Date)return c;if(typeof c=="string"){const e=Date.parse(c);if(isNaN(e))throw new Error(`Invalid date:[${c}]`);return new Date(e)}else if(typeof c=="number")return new Date(c);throw new Error(`Invalid date:[${c}]`)}function j(c){if(typeof c=="string"){const e=c.charAt(0).toUpperCase(),t=c.slice(1).toLowerCase(),r=g[`${e}${t}`];if(r===void 0)throw new Error(`Invalid state:[${c}]`);return r}else if(typeof c=="number")return c;throw new Error(`Invalid state:[${c}]`)}function Fe(c){if(typeof c=="string"){const e=c.charAt(0).toUpperCase(),t=c.slice(1).toLowerCase(),r=v[`${e}${t}`];if(r===void 0)throw new Error(`Invalid rating:[${c}]`);return r}else if(typeof c=="number")return c;throw new Error(`Invalid rating:[${c}]`)}v.Again,v.Hard,v.Good,v.Easy;const Be=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function ze(c,e,t){let r=1;for(const d of Be)r+=d.factor*Math.max(Math.min(c,d.end)-d.start,0);c=Math.min(c,t);let i=Math.max(2,Math.round(c-r));const o=Math.min(Math.round(c+r),t);return c>e&&(i=Math.max(i,e+1)),i=Math.min(i,o),{min_ivl:i,max_ivl:o}}class $e{again;hard;good;easy;last_review;last_elapsed_days;copy(e){return{...e}}constructor(e,t){this.last_review=e.last_review||e.due,this.last_elapsed_days=e.elapsed_days,e.elapsed_days=e.state===g.New?0:t.diff(e.last_review,"days"),e.last_review=t,e.reps+=1,this.again=this.copy(e),this.hard=this.copy(e),this.good=this.copy(e),this.easy=this.copy(e)}update_state(e){return e===g.New?(this.again.state=g.Learning,this.hard.state=g.Learning,this.good.state=g.Learning,this.easy.state=g.Review):e===g.Learning||e===g.Relearning?(this.again.state=e,this.hard.state=e,this.good.state=g.Review,this.easy.state=g.Review):e===g.Review&&(this.again.state=g.Relearning,this.hard.state=g.Review,this.good.state=g.Review,this.easy.state=g.Review,this.again.lapses+=1),this}schedule(e,t,r,i){return this.again.scheduled_days=0,this.hard.scheduled_days=t,this.good.scheduled_days=r,this.easy.scheduled_days=i,this.again.due=F(e,5),this.hard.due=t>0?F(e,t,!0):F(e,10),this.good.due=F(e,r,!0),this.easy.due=F(e,i,!0),this}record_log(e,t){return{[v.Again]:{card:this.again,log:{rating:v.Again,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:t}},[v.Hard]:{card:this.hard,log:{rating:v.Hard,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:t}},[v.Good]:{card:this.good,log:{rating:v.Good,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:t}},[v.Easy]:{card:this.easy,log:{rating:v.Easy,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:t}}}}}const Ge=.9,Pe=36500,Ue=[.5701,1.4436,4.1386,10.9355,5.1443,1.2006,.8627,.0362,1.629,.1342,1.0166,2.1174,.0839,.3204,1.4676,.219,2.8237],Oe=!1,X=c=>({request_retention:c?.request_retention||Ge,maximum_interval:c?.maximum_interval||Pe,w:c?.w||Ue,enable_fuzz:c?.enable_fuzz||Oe}),ae=-.5,re=19/81;class qe{param;intervalModifier;seed;constructor(e){this.param=new Proxy(X(e),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention)}get interval_modifier(){return this.intervalModifier}calculate_interval_modifier(e){if(e<=0||e>1)throw new Error("Requested retention rate should be in the range (0,1]");return+((Math.pow(e,1/ae)-1)/re).toFixed(8)}get parameters(){return this.param}set parameters(e){this.update_parameters(e)}params_handler_proxy(){const e=this;return{set:function(t,r,i){return r==="request_retention"&&Number.isFinite(i)&&(e.intervalModifier=e.calculate_interval_modifier(Number(i))),t[r]=i,!0}}}update_parameters(e){const t=X(e);for(const r in t)if(r in this.param){const i=r;this.param[i]=t[i]}}init_ds(e){e.again.difficulty=this.init_difficulty(v.Again),e.again.stability=this.init_stability(v.Again),e.hard.difficulty=this.init_difficulty(v.Hard),e.hard.stability=this.init_stability(v.Hard),e.good.difficulty=this.init_difficulty(v.Good),e.good.stability=this.init_stability(v.Good),e.easy.difficulty=this.init_difficulty(v.Easy),e.easy.stability=this.init_stability(v.Easy)}next_ds(e,t,r,i){e.again.difficulty=this.next_difficulty(t,v.Again),e.again.stability=this.next_forget_stability(t,r,i),e.hard.difficulty=this.next_difficulty(t,v.Hard),e.hard.stability=this.next_recall_stability(t,r,i,v.Hard),e.good.difficulty=this.next_difficulty(t,v.Good),e.good.stability=this.next_recall_stability(t,r,i,v.Good),e.easy.difficulty=this.next_difficulty(t,v.Easy),e.easy.stability=this.next_recall_stability(t,r,i,v.Easy)}init_stability(e){return Math.max(this.param.w[e-1],.1)}init_difficulty(e){return+Math.min(Math.max(this.param.w[4]-(e-3)*this.param.w[5],1),10).toFixed(8)}apply_fuzz(e,t,r){if(!r||e<2.5)return Math.round(e);const i=Ie(this.seed)(),{min_ivl:o,max_ivl:d}=ze(e,t,this.param.maximum_interval);return Math.floor(i*(d-o+1)+o)}next_interval(e,t,r=this.param.enable_fuzz){const i=Math.min(Math.max(1,Math.round(e*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(i,t,r)}next_difficulty(e,t){const r=e-this.param.w[6]*(t-3);return this.constrain_difficulty(this.mean_reversion(this.param.w[4],r))}constrain_difficulty(e){return Math.min(Math.max(+e.toFixed(8),1),10)}mean_reversion(e,t){return+(this.param.w[7]*e+(1-this.param.w[7])*t).toFixed(8)}next_recall_stability(e,t,r,i){const o=v.Hard===i?this.param.w[15]:1,d=v.Easy===i?this.param.w[16]:1;return+(t*(1+Math.exp(this.param.w[8])*(11-e)*Math.pow(t,-this.param.w[9])*(Math.exp((1-r)*this.param.w[10])-1)*o*d)).toFixed(8)}next_forget_stability(e,t,r){return+(this.param.w[11]*Math.pow(e,-this.param.w[12])*(Math.pow(t+1,this.param.w[13])-1)*Math.exp((1-r)*this.param.w[14])).toFixed(8)}forgetting_curve(e,t){return+Math.pow(1+re*e/t,ae).toFixed(8)}}class He extends qe{constructor(e){super(e)}preProcessCard(e){return{...e,state:j(e.state),due:b(e.due),last_review:e.last_review?b(e.last_review):void 0}}preProcessDate(e){return b(e)}preProcessLog(e){return{...e,due:b(e.due),rating:Fe(e.rating),state:j(e.state),review:b(e.review)}}repeat(e,t,r){const i=this.preProcessCard(e);t=this.preProcessDate(t);const o=new $e(i,t).update_state(i.state);this.seed=String(t.getTime())+String(i.reps);let d,s,a;const n=i.elapsed_days;switch(i.state){case g.New:this.init_ds(o),o.again.due=t.scheduler(1),o.hard.due=t.scheduler(5),o.good.due=t.scheduler(10),d=this.next_interval(o.easy.stability,n),o.easy.scheduled_days=d,o.easy.due=t.scheduler(d,!0);break;case g.Learning:case g.Relearning:a=0,s=this.next_interval(o.good.stability,n),d=Math.max(this.next_interval(o.easy.stability,n),s+1),o.schedule(t,a,s,d);break;case g.Review:{const l=i.difficulty,u=i.stability,f=this.forgetting_curve(n,u);this.next_ds(o,l,u,f),a=this.next_interval(o.hard.stability,n),s=this.next_interval(o.good.stability,n),a=Math.min(a,s),s=Math.max(s,a+1),d=Math.max(this.next_interval(o.easy.stability,n),s+1),o.schedule(t,a,s,d);break}}const h=o.record_log(i,t);return r&&typeof r=="function"?r(h):h}get_retrievability(e,t,r=!0){const i=this.preProcessCard(e);if(t=this.preProcessDate(t),i.state!==g.Review)return;const o=Math.max(t.diff(i.last_review,"days"),0),d=this.forgetting_curve(o,Math.round(i.stability));return r?`${(d*100).toFixed(2)}%`:d}rollback(e,t,r){const i=this.preProcessCard(e),o=this.preProcessLog(t);if(o.rating===v.Manual)throw new Error("Cannot rollback a manual rating");let d,s,a;switch(o.state){case g.New:d=o.due,s=void 0,a=0;break;case g.Learning:case g.Relearning:case g.Review:d=o.review,s=o.due,a=i.lapses-(o.rating===v.Again&&o.state===g.Review?1:0);break}const n={...i,due:d,stability:o.stability,difficulty:o.difficulty,elapsed_days:o.last_elapsed_days,scheduled_days:o.scheduled_days,reps:Math.max(0,i.reps-1),lapses:Math.max(0,a),state:o.state,last_review:s};return r&&typeof r=="function"?r(n):n}forget(e,t,r=!1,i){const o=this.preProcessCard(e);t=this.preProcessDate(t);const d=o.state===g.New?0:t.diff(o.last_review,"days"),s={rating:v.Manual,state:o.state,due:o.due,stability:o.stability,difficulty:o.difficulty,elapsed_days:0,last_elapsed_days:o.elapsed_days,scheduled_days:d,review:t},a={card:{...o,due:t,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:r?0:o.reps,lapses:r?0:o.lapses,state:g.New,last_review:o.last_review},log:s};return i&&typeof i=="function"?i(a):a}reschedule(e,t={}){if(!Array.isArray(e))throw new Error("cards must be an array");const r=[];for(const i of e){if(j(i.state)!==g.Review||!i.last_review)continue;const o=Math.floor(i.scheduled_days),d=this.next_interval(+i.stability.toFixed(2),Math.round(i.elapsed_days),t.enable_fuzz??!0);if(d===o||d===0)continue;const s={...i};s.scheduled_days=d;const a=F(s.last_review,d,!0);t.dateHandler&&typeof t.dateHandler=="function"?s.due=t.dateHandler(a):s.due=a,r.push(s)}return r}}class ne{constructor(){this.userSettings={learningSteps:"1 10",relearningSteps:"10",dailyNewCardsLimit:20,dailyReviewLimit:200,enableTraditionalLearningSteps:!1},this.config={...oe},this.fsrsInstance=this.createFSRSInstance(this.config),this.initializeUserSettings()}async initializeUserSettings(){try{this.userSettings=await ce(),le(e=>{this.userSettings={...this.userSettings,...e},console.log("FSRS service updated with new settings:",this.userSettings)})}catch(e){console.error("Failed to initialize user settings:",e)}}createFSRSInstance(e){const t=X({request_retention:e.requestRetention,maximum_interval:e.maximumInterval,enable_fuzz:!0});return new He(t)}convertToFSRSCard(e){return{due:e.due,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsedDays,scheduled_days:e.scheduledDays,reps:e.reps,lapses:e.lapses,state:this.convertToFSRSState(e.state),last_review:e.lastReview||void 0}}convertToAppCard(e){return{due:e.due,stability:e.stability,difficulty:e.difficulty,elapsedDays:e.elapsed_days,scheduledDays:e.scheduled_days,reps:e.reps,lapses:e.lapses,state:this.convertFromFSRSState(e.state),lastReview:e.last_review}}convertToFSRSState(e){switch(e){case"New":return g.New;case"Learning":return g.Learning;case"Review":return g.Review;case"Relearning":return g.Relearning;default:return g.New}}convertFromFSRSState(e){switch(e){case g.New:return"New";case g.Learning:return"Learning";case g.Review:return"Review";case g.Relearning:return"Relearning";default:return"New"}}mapRatingToFSRS(e){switch(e){case"Again":return v.Again;case"Hard":return v.Hard;case"Good":return v.Good;case"Easy":return v.Easy;default:return v.Good}}async reviewCard(e,t){try{const r=await p.getCardById(e);if(!r)throw new Error(`Card with id ${e} not found`);const i=new Date;return this.userSettings.enableTraditionalLearningSteps?await this.handleTraditionalLearningSteps(r,t,i):await this.handleTaskDrivenLearning(r,t,i)}catch(r){return console.error("Error reviewing card:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}async handleTaskDrivenLearning(e,t,r){if(e.state==="New"||e.state==="Relearning"){if(t==="Good"||t==="Easy")return await this.graduateCardToReview(e,t,r);{const i=await p.updateCard(e.id,{due:r,updatedAt:r});return await this.logReview(e,i,t,r),{success:!0,nextReview:i.due,interval:0}}}else if(e.state==="Review")if(t==="Again"){const i=await p.updateCard(e.id,{state:"Relearning",learningStep:0,due:r,lapses:e.lapses+1,updatedAt:r});return await this.logReview(e,i,t,r),{success:!0,nextReview:i.due,interval:0}}else return await this.applyFSRSScheduling(e,t,r);else return await this.applyFSRSScheduling(e,t,r)}async handleTraditionalLearningSteps(e,t,r){if(e.state==="New"||e.state==="Learning")return await this.handleLearningSteps(e,t,r,"learningSteps");if(e.state==="Relearning")return await this.handleLearningSteps(e,t,r,"relearningSteps");if(e.state==="Review")if(t==="Again"){const i=await p.updateCard(e.id,{state:"Relearning",learningStep:0,due:this.calculateStepDue(r,0,"relearningSteps"),lapses:e.lapses+1,updatedAt:r});return await this.logReview(e,i,t,r),{success:!0,nextReview:i.due,interval:0}}else return await this.applyFSRSScheduling(e,t,r);return await this.applyFSRSScheduling(e,t,r)}async handleLearningSteps(e,t,r,i){const o=i==="learningSteps"?this.userSettings.learningSteps:this.userSettings.relearningSteps,d=ee(o);if(t==="Again"){const s=await p.updateCard(e.id,{learningStep:0,due:this.calculateStepDue(r,0,i),updatedAt:r});return await this.logReview(e,s,t,r),{success:!0,nextReview:s.due,interval:0}}else{if(t==="Easy")return await this.graduateCardToReview(e,t,r);if(t==="Good"||t==="Hard"){const a=(e.learningStep||0)+1;if(a>=d.length)return await this.graduateCardToReview(e,t,r);{const n=await p.updateCard(e.id,{state:i==="learningSteps"?"Learning":"Relearning",learningStep:a,due:this.calculateStepDue(r,a,i),updatedAt:r});return await this.logReview(e,n,t,r),{success:!0,nextReview:n.due,interval:0}}}}return await this.applyFSRSScheduling(e,t,r)}calculateStepDue(e,t,r){const i=r==="learningSteps"?this.userSettings.learningSteps:this.userSettings.relearningSteps,o=ee(i);if(t>=o.length)return e;const d=o[t];return new Date(e.getTime()+d*60*1e3)}async graduateCardToReview(e,t,r){const i={due:r,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:e.lapses,state:g.New,last_review:void 0},o=this.mapRatingToFSRS(t),s=this.fsrsInstance.repeat(i,r)[o],a=this.convertToAppCard(s.card),n=await p.updateCard(e.id,{...a,state:"Review",learningStep:1,reps:e.reps+1});return await this.logReview(e,n,t,r),{success:!0,nextReview:n.due,interval:n.scheduledDays}}async applyFSRSScheduling(e,t,r){const i=this.convertToFSRSCard(e),o=this.mapRatingToFSRS(t),s=this.fsrsInstance.repeat(i,r)[o],a=this.convertToAppCard(s.card),n=await p.updateCard(e.id,{...a,reps:e.reps+1});return await this.logReview(e,n,t,r),{success:!0,nextReview:n.due,interval:n.scheduledDays}}async logReview(e,t,r,i){await p.addReviewLog({cardId:e.id,reviewTime:i,rating:this.convertAppRatingToNumber(r),stateBefore:e.state,stateAfter:t.state,stabilityBefore:e.stability,stabilityAfter:t.stability,difficultyBefore:e.difficulty,difficultyAfter:t.difficulty,interval:t.scheduledDays,lastInterval:e.scheduledDays})}convertAppRatingToNumber(e){switch(e){case"Again":return 1;case"Hard":return 2;case"Good":return 3;case"Easy":return 4;default:return 3}}async getNextReviewDate(e,t){const r=this.convertToFSRSCard(e),i=this.mapRatingToFSRS(t);return this.fsrsInstance.repeat(r,new Date)[i].card.due}async predictRetention(e){const r=(new Date().getTime()-e.due.getTime())/(1e3*60*60*24);return e.stability>0?Math.exp(-r/e.stability):.9}async calculateLearningProgress(e){const t=e.length,r=e.filter(n=>n.state==="New").length,i=e.filter(n=>n.state==="Learning").length,o=e.filter(n=>n.state==="Review").length;let d=0,s=0;for(const n of e)if(n.state==="Review"&&n.stability>0){const h=await this.predictRetention(n);d+=h,s++}const a=s>0?d/s:.9;return{totalCards:t,newCards:r,learningCards:i,reviewCards:o,averageRetention:a,studyStreak:0}}async recommendStudySchedule(e){const t=new Date,r=e.filter(s=>s.due<=t).length,i=new Date(t);i.setDate(i.getDate()+1);const o=e.filter(s=>s.due>t&&s.due<=i).length,d=Math.max(20,Math.min(50,r+10));return{immediateReview:r,todayTotal:r,tomorrowTotal:o,recommendedDailyLimit:d}}updateConfig(e){if(e.requestRetention!==void 0&&(e.requestRetention<=0||e.requestRetention>1))throw new Error("Request retention must be between 0 and 1");if(e.maximumInterval!==void 0&&e.maximumInterval<0)throw new Error("Maximum interval must be non-negative");if(e.easyBonus!==void 0&&e.easyBonus<1)throw new Error("Easy bonus must be >= 1");if(e.hardFactor!==void 0&&e.hardFactor<=0)throw new Error("Hard factor must be positive");this.config={...this.config,...e},this.fsrsInstance=this.createFSRSInstance(this.config)}getConfig(){return{...this.config}}}new ne;class Ke{async buildQueue(e,t=20){try{console.log(`SchedulerService: Building queue for deck ${e}, limit ${t}`);const r=await p.getDueCards(e||void 0,t);return console.log(`SchedulerService: Found ${r.length} due cards`),r}catch(r){throw console.error("SchedulerService: Error building queue:",r),new Error(`Failed to build review queue: ${r instanceof Error?r.message:"Unknown error"}`)}}async buildDailyQueue(e){const t=await this.buildQueue(e);return{cards:t,newCards:t.filter(r=>r.state==="New"),learningCards:t.filter(r=>r.state==="Learning"),reviewCards:t.filter(r=>r.state==="Review"),totalCount:t.length}}async getNewCards(e,t){if(e===null){const r=await p.getAllDecks(),i=[];for(const o of r){const d=await p.getCardsByDeckId(o.id);i.push(...d)}return i.filter(o=>o.state==="New").slice(0,t)}else return(await p.getCardsByDeckId(e)).filter(i=>i.state==="New").slice(0,t)}async getLearningCards(e){const t=new Date;if(e===null){const r=await p.getAllDecks(),i=[];for(const o of r){const d=await p.getCardsByDeckId(o.id);i.push(...d)}return i.filter(o=>o.state!=="Learning"?!1:o.due?new Date(o.due)<=t:!0)}else return(await p.getCardsByDeckId(e)).filter(i=>i.state!=="Learning"?!1:i.due?new Date(i.due)<=t:!0)}async getReviewCards(e,t){const r=new Date;if(e===null){const i=await p.getAllDecks(),o=[];for(const d of i){const s=await p.getCardsByDeckId(d.id);o.push(...s)}return o.filter(d=>d.state!=="Review"||!d.due?!1:new Date(d.due)<=r).slice(0,t)}else return(await p.getCardsByDeckId(e)).filter(o=>o.state!=="Review"||!o.due?!1:new Date(o.due)<=r).slice(0,t)}async resetCardsInDeck(e){try{console.log(`SchedulerService: Resetting cards in deck ${e||"all decks"}`);const t=await p.resetCardsInDeck(e);return console.log(`SchedulerService: Successfully reset ${t} cards`),t}catch(t){throw console.error("SchedulerService: Error resetting cards:",t),new Error(`Failed to reset cards: ${t instanceof Error?t.message:"Unknown error"}`)}}async getQueueStats(e){try{const t=new Date;let r;if(e===null){const s=await p.getAllDecks();r=[];for(const a of s){const n=await p.getCardsByDeckId(a.id);r.push(...n)}}else r=await p.getCardsByDeckId(e);const i=r.filter(s=>s.state==="New").length,o=r.filter(s=>s.state==="Learning"&&(!s.due||new Date(s.due)<=t)).length,d=r.filter(s=>s.state==="Review"&&s.due&&new Date(s.due)<=t).length;return{newCount:i,learningCount:o,reviewCount:d,totalCount:i+o+d}}catch(t){return console.error("SchedulerService: Error getting queue stats:",t),{newCount:0,learningCount:0,reviewCount:0,totalCount:0}}}}const ie=new Ke,N=new ne;class je{constructor(){this.initialized=!1}get isInitialized(){return this.initialized}async init(){if(!this.initialized)try{console.log("Initializing AnGear Background Service..."),await p.initDatabase(),await this.setupAlarms(),await this.initializeDefaultConfig(),this.initialized=!0,console.log("AnGear Background Service initialized successfully"),await this.updateBadge()}catch(e){throw console.error("Failed to initialize background service:",e),e}}async initializeWithRetry(e=3){if(this.initialized)return;let t;for(let i=1;i<=e;i++)try{if(console.log(`Initialization attempt ${i}/${e}`),await this.init(),this.initialized){console.log(`Initialization successful on attempt ${i}`);return}}catch(o){if(t=o instanceof Error?o:new Error(String(o)),console.error(`Initialization attempt ${i} failed:`,t.message),i<e){const d=i*1e3;console.log(`Waiting ${d}ms before retry...`),await new Promise(s=>setTimeout(s,d))}}const r=new Error(`Failed to initialize after ${e} attempts. Last error: ${t?.message||"Unknown error"}`);throw console.error("Critical initialization failure:",r.message),r}async setupAlarms(){await chrome.alarms.clearAll(),await chrome.alarms.create("daily-check",{delayInMinutes:1,periodInMinutes:60}),await chrome.alarms.create("health-check",{delayInMinutes:5,periodInMinutes:30}),console.log("Alarms set up successfully")}async initializeDefaultConfig(){console.log("Using default FSRS configuration")}async updateBadge(){try{const t=(await p.getDueCards()).length;t>0?(await chrome.action.setBadgeText({text:t>99?"99+":t.toString()}),await chrome.action.setBadgeBackgroundColor({color:"#E53E3E"})):await chrome.action.setBadgeText({text:""})}catch(e){console.error("Failed to update badge:",e)}}async handleAlarm(e){switch(e.name){case"daily-check":console.log("Running daily check..."),await this.updateBadge();break;default:console.log(`Unknown alarm: ${e.name}`)}}async handleMessage(e,t){try{switch(console.log(`Received message: ${e.type}`,e),this.initialized||(console.log("Service not initialized, attempting initialization..."),await this.initializeWithRetry()),e.type){case"CREATE_DECK":const r=await p.createDeck(e.payload);return await this.updateBadge(),{success:!0,data:r};case"GET_ALL_DECKS":return{success:!0,data:await p.getAllDecks()};case"GET_DECK_BY_ID":return{success:!0,data:await p.getDeckById(e.payload.id)};case"UPDATE_DECK":return await p.updateDeck(e.payload.id,e.payload.updates),{success:!0};case"DELETE_DECK":return await p.deleteDeck(e.payload.id),await this.updateBadge(),{success:!0};case"GET_DECK_STATS":return{success:!0,data:await p.getDeckStatistics(e.payload.deckId)};case"CREATE_NOTE":try{console.log("Creating note with payload:",e.payload);const w=await p.createNote(e.payload);return await p.createCardsForNote(w),await this.updateBadge(),console.log("Note and cards created successfully:",w.id),{success:!0,data:w}}catch(w){if(console.error("CREATE_NOTE operation failed:",w),w instanceof Error){if(w.message.includes("Duplicate key conflict"))return{success:!1,error:"Note creation failed due to database conflict. Please try again or restart the extension."};if(w.name==="ConstraintError"||w.message.includes("Key already exists"))return{success:!1,error:"Database constraint violation: A note with this identifier already exists. Please refresh the page and try again."}}throw w}case"GET_NOTES_BY_DECK":return{success:!0,data:await p.getNotesByDeckId(e.payload.deckId)};case"UPDATE_NOTE":return await p.updateNote(e.payload.id,e.payload.updates),{success:!0};case"DELETE_NOTE":return await p.deleteNote(e.payload.id),await this.updateBadge(),{success:!0};case"GET_NOTE_BY_ID":return{success:!0,data:await p.getNoteById(e.payload.id)};case"BULK_CREATE_NOTES":try{console.log("Bulk creating notes:",e.payload);const{deckId:w,notes:m}=e.payload,S=m.map(C=>({...C,deckId:w})),E=await p.bulkCreateNotes(S);return await this.updateBadge(),console.log(`Bulk created ${E.length} notes successfully`),{success:!0,data:E}}catch(w){throw console.error("BULK_CREATE_NOTES operation failed:",w),w}case"AI_PROCESS_TEXT":try{const{geminiService:w}=await q(async()=>{const{geminiService:C}=await import("../../geminiService-BtT-p0u-.js");return{geminiService:C}},[]),{getSettings:m}=await q(async()=>{const{getSettings:C}=await import("../../db-0AuwIzuQ.js").then(D=>D.e);return{getSettings:C}},[]),S=await m();return S.geminiApiKey?{success:!0,data:await w.processTextForCards(e.payload.text,S.geminiApiKey)}:{success:!1,error:"请先在设置页面配置Gemini API密钥"}}catch(w){return console.error("AI_PROCESS_TEXT操作失败:",w),{success:!1,error:w instanceof Error?w.message:"AI处理失败"}}case"VERIFY_GEMINI_API_KEY":try{const{geminiService:w}=await q(async()=>{const{geminiService:E}=await import("../../geminiService-BtT-p0u-.js");return{geminiService:E}},[]),{apiKey:m}=e.payload;return!m||typeof m!="string"?{success:!1,error:"API密钥不能为空"}:{success:!0,data:await w.validateApiKey(m)}}catch(w){return console.error("VERIFY_GEMINI_API_KEY操作失败:",w),{success:!1,error:w instanceof Error?w.message:"API密钥验证失败"}}case"GET_DUE_CARDS":return{success:!0,data:await p.getDueCards(e.payload?.deckId,e.payload?.limit)};case"REVIEW_CARD":const h=await N.reviewCard(e.payload.cardId,e.payload.rating);return await this.updateBadge(),{success:!0,data:h};case"GET_CARD_PREDICTIONS":const l=await p.getCardById(e.payload.cardId);return l?{success:!0,data:{again:await N.getNextReviewDate(l,"Again"),hard:await N.getNextReviewDate(l,"Hard"),good:await N.getNextReviewDate(l,"Good"),easy:await N.getNextReviewDate(l,"Easy")}}:{success:!1,error:"Card not found"};case"GET_CARDS_BY_DECK":return{success:!0,data:await p.getCardsByDeckId(e.payload.deckId)};case"RESET_CARD_PROGRESS":return await p.resetCardProgress(e.payload.cardId),await this.updateBadge(),{success:!0};case"GET_FSRS_CONFIG":return{success:!0,data:N.getConfig()};case"UPDATE_FSRS_CONFIG":return N.updateConfig(e.payload),{success:!0};case"GET_FSRS_STATS":const R=await p.getCardsByDeckId(e.payload.deckId);return{success:!0,data:await N.calculateLearningProgress(R)};case"GET_USER_CONFIG":return{success:!0,data:{theme:"auto",language:"zh-CN"}};case"SAVE_USER_CONFIG":return{success:!0};case"GET_DATABASE_SIZE":return{success:!0,data:{decks:(await p.getAllDecks()).length}};case"VALIDATE_DATABASE_INTEGRITY":return{success:!0,data:await p.validateDatabaseIntegrity()};case"CLEAR_ALL_DATA":return await p.clearAllData(),await this.updateBadge(),{success:!0};case"STORE_AUDIO":return{success:!1,error:"Audio storage not implemented yet"};case"GET_AUDIO":return{success:!1,error:"Audio retrieval not implemented yet"};case"GET_AUDIO_CLIP":const M=await p.getAudioClip(e.payload.id);return M?{success:!0,data:M}:{success:!1,error:"Audio clip not found"};case"DELETE_AUDIO":return{success:!1,error:"Audio deletion not implemented yet"};case"BUILD_QUEUE":return{success:!0,data:await ie.buildQueue(e.payload?.deckId,e.payload?.limit)};case"RESET_CARDS_IN_DECK":const x=await ie.resetCardsInDeck(e.payload.deckId);return await this.updateBadge(),{success:!0,data:x};default:return console.warn(`Unknown message type: ${e.type}`),{success:!1,error:`Unknown message type: ${e.type}`}}}catch(r){return console.error(`Error handling message ${e.type}:`,r),r instanceof Error&&r.message.includes("Failed to initialize")?{success:!1,error:"应用初始化失败，请尝试重新加载扩展。如果问题持续存在，请检查浏览器控制台获取详细错误信息。"}:r instanceof Error&&r.message.includes("Database not initialized")?{success:!1,error:"数据库连接失败，正在尝试重新连接...请稍后重试。"}:{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}getCardTemplatesForNoteType(e){switch(e){case"CtoE":return["CtoE_ZhToEn"];case"Retranslate":return["Retranslate_Forward","Retranslate_Backward"];case"SentenceParaphrase":return["SentenceParaphrase_Listen","SentenceParaphrase_Speak"];case"Article":return["Article_Reading","Article_Questions"];default:return["Basic"]}}}const O=new je;chrome.runtime.onStartup.addListener(async()=>{console.log("Extension startup");try{await O.init()}catch(c){console.error("Failed to initialize on startup:",c)}});chrome.runtime.onInstalled.addListener(async()=>{console.log("Extension installed");try{await O.init()}catch(c){console.error("Failed to initialize on install:",c)}});chrome.runtime.onMessage.addListener((c,e,t)=>(O.handleMessage(c,e).then(r=>t(r)).catch(r=>{console.error("Message handling failed:",r),t({success:!1,error:r instanceof Error?r.message:"Unknown error"})}),!0));chrome.alarms.onAlarm.addListener(async c=>{try{await O.handleAlarm(c)}catch(e){console.error("Alarm handling failed:",e)}});
